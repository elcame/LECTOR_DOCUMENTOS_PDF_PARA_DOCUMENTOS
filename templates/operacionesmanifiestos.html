<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operaciones de Manifiestos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/operaciones.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>üìä Operaciones de Manifiestos</h1>
                    <p>Agregados mensuales por placa y buscador por Load ID</p>
                </div>
                <a class="close-app-btn" href="/" title="Volver">
                    ‚¨ÖÔ∏è Volver
                </a>
            </div>
        </div>

        <!-- Gesti√≥n de Veh√≠culos -->
        <div class="vehicles-section-modern" style="margin-top: 20px;">
            <div class="vehicles-section-header">
                <h4>üöõ Gesti√≥n de Veh√≠culos</h4>
                <p>Selecciona una placa para gestionar los datos del veh√≠culo</p>
            </div>
            
            <!-- Contenedor de placas de veh√≠culos -->
            <div class="plates-vehicles-container" id="platesVehiclesContainer">
                <div class="loading-plates">Cargando placas...</div>
            </div>
            
            <div class="vehicles-form-actions">
                <button id="saveVehiclesBtn" class="btn-save-expense">üíæ Guardar Todos</button>
                <button id="loadVehiclesBtn" class="btn-load-expense">üîÑ Cargar Veh√≠culos</button>
            </div>
        </div>

        <div class="upload-section" style="margin-top: 16px;">
            <h3>üîé Buscar por Load ID</h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <input id="searchInput" type="text" class="custom-field-input" placeholder="Ej: 4665176" style="flex:1;" />
                <button id="searchBtn" class="process-btn">Buscar</button>
                <button id="clearBtn" class="btn-cancel">Limpiar</button>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: block;">
            <h3>üìà Navegaci√≥n por Mes y Placa</h3>
            
            <!-- Navegaci√≥n por Mes -->
            <div class="month-navigation">
                <button id="prevMonthBtn" class="nav-btn" disabled>‚¨ÖÔ∏è</button>
                <div class="month-display">
                    <h4 id="currentMonth">Cargando...</h4>
                    <span id="monthStats">0 placas</span>
                </div>
                <button id="nextMonthBtn" class="nav-btn" disabled>‚û°Ô∏è</button>
            </div>

            <!-- Placas del Mes Actual -->
            <div class="plates-container" id="platesContainer">
                <div class="loading-plates">Cargando placas...</div>
            </div>

            <!-- Gesti√≥n de Tarifas por Destino -->
            <div class="tarifas-section" id="tarifasSection" style="margin-top: 24px;">
                <h3>üí∞ Gesti√≥n de Tarifas por Destino</h3>
                <div class="tarifas-container">
                    <div class="tarifas-header">
                        <p>Asigna el valor que pagar√°s a cada conductor seg√∫n el destino del viaje</p>
                        <div class="tarifas-actions">
                            <button id="loadTarifasBtn" class="btn-cancel">üîÑ Cargar Tarifas</button>
                            <button id="saveTarifasBtn" class="process-btn">üíæ Guardar Tarifas</button>
                        </div>
                    </div>
                    <div class="tarifas-grid" id="tarifasGrid">
                        <div class="loading-tarifas">Cargando destinos...</div>
                    </div>
                </div>
            </div>

            <!-- Resumen Financiero -->
            <div class="financial-summary" id="financialSummary" style="margin-top: 24px;">
                <h3>üí∞ Resumen Financiero</h3>
                <div class="summary-cards">
                    <div class="summary-card income">
                        <div class="card-icon">üìà</div>
                        <div class="card-content">
                            <div class="card-label">Ingresos Totales</div>
                            <div class="card-value" id="totalIncome">$0</div>
                        </div>
                    </div>
                    <div class="summary-card expenses">
                        <div class="card-icon">üìâ</div>
                        <div class="card-content">
                            <div class="card-label">Gastos Totales</div>
                            <div class="card-value" id="totalExpenses">$0</div>
                        </div>
                    </div>
                    <div class="summary-card profit">
                        <div class="card-icon">üíµ</div>
                        <div class="card-content">
                            <div class="card-label">Utilidad Neta</div>
                            <div class="card-value" id="netProfit">$0</div>
                        </div>
                    </div>
                    <div class="summary-card income" style="border-left: 4px solid #17a2b8;">
                        <div class="card-icon">üí∞</div>
                        <div class="card-content">
                            <div class="card-label">Dinero Manifiestos Pagados</div>
                            <div class="card-value" id="totalManifiestosPagados" style="color: #17a2b8;">$0</div>
                        </div>
                    </div>
                </div>
                <div class="expenses-breakdown" id="expensesBreakdown" style="margin-top: 16px;">
                    <h4>üìä Desglose de Gastos</h4>
                    <div class="breakdown-grid">
                        <div class="breakdown-item-total">
                            <div class="breakdown-item-header">
                                <span class="breakdown-label">Gastos en Conductores:</span>
                                <span class="breakdown-value" id="expensesDrivers">$0</span>
                            </div>
                            <div class="breakdown-item-details">
                                <div class="breakdown-detail-row">
                                    <span class="breakdown-sub-label">üíµ Total Pagado:</span>
                                    <span class="breakdown-sub-value paid" id="expensesDriversPaid">$0</span>
                                </div>
                                <div class="breakdown-detail-row">
                                    <span class="breakdown-sub-label">‚è≥ Total Pendiente:</span>
                                    <span class="breakdown-sub-value pending" id="expensesDriversPending">$0</span>
                                </div>
                            </div>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Parqueaderos:</span>
                            <span class="breakdown-value" id="expensesParking">$0</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Repuestos:</span>
                            <span class="breakdown-value" id="expensesParts">$0</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Mano de Obra:</span>
                            <span class="breakdown-value" id="expensesLabor">$0</span>
                        </div>
                        <!-- Gesti√≥n de Pagos (Tarjeta en desglose) -->
                        <div class="breakdown-item" id="paymentsManagementCard" style="grid-column: 1 / -1; display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #2196f3;">
                            <div style="display:flex; gap: 12px; align-items:center; flex-wrap: wrap;">
                                <span class="breakdown-label" style="font-weight: 600; color: #1976d2;">üí≥ Gesti√≥n de Pagos a Conductores:</span>
                                <select id="conductorSelectForPayments" class="form-input" style="min-width: 240px; padding: 8px 12px; border: 2px solid #2196f3; border-radius: 6px;"></select>
                            </div>
                            <button class="process-btn" id="openPaymentsFromBreakdownBtn" style="padding: 10px 20px;">Abrir Gesti√≥n</button>
                        </div>
                    </div>
                    
                    <!-- Gesti√≥n de Gastos Adicionales por Placa -->
                    <div class="expenses-form-modern" style="margin-top: 20px;">
                        <div class="expenses-form-header">
                            <h4>‚úèÔ∏è Gastos Adicionales por Placa</h4>
                            <p>Selecciona una placa para gestionar sus gastos operativos</p>
                        </div>
                        
                        <!-- Contenedor de placas -->
                        <div class="plates-expenses-container" id="platesExpensesContainer">
                            <div class="loading-plates">Cargando placas...</div>
                        </div>
                        
                        <div class="expense-form-actions">
                            <button id="saveExpensesBtn" class="btn-save-expense">üíæ Guardar Todos</button>
                            <button id="loadExpensesBtn" class="btn-load-expense">üîÑ Cargar Gastos</button>
                        </div>
                    </div>

                    <!-- Lista de Pagos Realizados -->
                    <div class="payments-list-section" style="margin-top: 24px;">
                        <h4>üí≥ Pagos Realizados a Conductores</h4>
                        <div id="paymentsListContainer" class="payments-list"></div>
                    </div>
                </div>
            </div>

            <h3 style="margin-top:24px;">üîç Coincidencias por Load ID</h3>
            <div class="tables-container">
                <div class="table-wrapper" id="matchesWrapper">
                    <h4>üîé Resultados de B√∫squeda</h4>
                    <div class="table-container" id="matchesTable"></div>
                </div>
            </div>
        </div>

        <!-- Modal para Detalles de Viajes -->
        <div id="tripsModal" class="modal">
            <div class="modal-content" style="max-width: 1400px; width: 95%;">
                <div class="modal-header">
                    <h3 id="modalTitle">Detalles de Viajes</h3>
                    <span class="close" onclick="closeTripsModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="modal-summary" id="modalSummary"></div>
                    <div class="table-container" id="modalTable" style="max-height: 60vh; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Modal para Gesti√≥n de Veh√≠culo -->
        <div id="vehicleModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 id="vehicleModalTitle">üöõ Datos del Veh√≠culo - <span id="vehicleModalPlaca"></span></h3>
                    <span class="close" onclick="closeVehicleModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- Formulario de datos del veh√≠culo -->
                    <div class="vehicle-form-professional">
                        <div class="vehicle-form-header-professional">
                            <div class="vehicle-form-icon-wrapper">
                                <div class="vehicle-form-icon">üöõ</div>
                            </div>
                            <div class="vehicle-form-title-section">
                                <h5 class="vehicle-form-title">Informaci√≥n del Veh√≠culo</h5>
                                <p class="vehicle-form-subtitle">Completa los datos del veh√≠culo</p>
                            </div>
                        </div>
                        <div class="vehicle-form-grid-professional">
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üöó</span>
                                    <span class="label-text">Placa</span>
                                </label>
                                <input type="text" id="vehiclePlacaModal" class="form-input-professional" readonly>
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üìã</span>
                                    <span class="label-text">Modelo</span>
                                </label>
                                <input type="text" id="vehicleModeloModal" class="form-input-professional" placeholder="Ej: 2020, 2021, etc.">
                            </div>
                            <!-- SOAT -->
                            <div class="form-field-professional form-field-full-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üõ°Ô∏è</span>
                                    <span class="label-text">SOAT (Fecha de Vencimiento)</span>
                                </label>
                                <input type="date" id="vehicleSoatModal" class="form-input-professional">
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üí∞</span>
                                    <span class="label-text">Valor SOAT (COP)</span>
                                </label>
                                <div class="expense-input-wrapper-professional">
                                    <span class="expense-currency-professional">$</span>
                                    <input type="number" id="vehicleSoatValorModal" class="expense-input-professional" placeholder="0" min="0" step="1000">
                                </div>
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional" style="opacity: 0;">Acci√≥n</label>
                                <button type="button" class="btn-pay-document" onclick="pagarDocumento('SOAT')">
                                    <span class="btn-icon">üí≥</span>
                                    <span class="btn-text">Pagar SOAT</span>
                                </button>
                            </div>
                            
                            <!-- Seguro -->
                            <div class="form-field-professional form-field-full-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üîí</span>
                                    <span class="label-text">Seguro (Fecha de Vencimiento)</span>
                                </label>
                                <input type="date" id="vehicleSeguroModal" class="form-input-professional">
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üí∞</span>
                                    <span class="label-text">Valor Seguro (COP)</span>
                                </label>
                                <div class="expense-input-wrapper-professional">
                                    <span class="expense-currency-professional">$</span>
                                    <input type="number" id="vehicleSeguroValorModal" class="expense-input-professional" placeholder="0" min="0" step="1000">
                                </div>
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional" style="opacity: 0;">Acci√≥n</label>
                                <button type="button" class="btn-pay-document" onclick="pagarDocumento('Seguro')">
                                    <span class="btn-icon">üí≥</span>
                                    <span class="btn-text">Pagar Seguro</span>
                                </button>
                            </div>
                            
                            <!-- Tecnomec√°nica -->
                            <div class="form-field-professional form-field-full-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üîß</span>
                                    <span class="label-text">Tecnomec√°nica (Fecha de Vencimiento)</span>
                                </label>
                                <input type="date" id="vehicleTecnomecanicaModal" class="form-input-professional">
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üí∞</span>
                                    <span class="label-text">Valor Tecnomec√°nica (COP)</span>
                                </label>
                                <div class="expense-input-wrapper-professional">
                                    <span class="expense-currency-professional">$</span>
                                    <input type="number" id="vehicleTecnomecanicaValorModal" class="expense-input-professional" placeholder="0" min="0" step="1000">
                                </div>
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional" style="opacity: 0;">Acci√≥n</label>
                                <button type="button" class="btn-pay-document" onclick="pagarDocumento('Tecnomec√°nica')">
                                    <span class="btn-icon">üí≥</span>
                                    <span class="btn-text">Pagar Tecnomec√°nica</span>
                                </button>
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üë§</span>
                                    <span class="label-text">Propietario</span>
                                </label>
                                <input type="text" id="vehiclePropietarioModal" class="form-input-professional" placeholder="Nombre del propietario">
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üí∞</span>
                                    <span class="label-text">Valor (COP)</span>
                                </label>
                                <div class="expense-input-wrapper-professional">
                                    <span class="expense-currency-professional">$</span>
                                    <input type="number" id="vehicleValorModal" class="expense-input-professional" placeholder="0" min="0" step="1000">
                                </div>
                            </div>
                            <div class="form-field-actions-professional">
                                <button id="saveVehicleBtnModal" class="btn-add-expense-professional">
                                    <span class="btn-icon">üíæ</span>
                                    <span class="btn-text">Guardar Datos</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acci√≥n del modal -->
                    <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn-cancel" onclick="closeVehicleModal()">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Gesti√≥n de Gastos por Placa -->
        <div id="expensesModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 id="expensesModalTitle">üí∞ Gastos Adicionales - <span id="expensesModalPlaca"></span></h3>
                    <span class="close" onclick="closeExpensesModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- Resumen de gastos de la placa -->
                    <div class="expense-summary-info" style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                            <div class="info-card">
                                <div class="info-label">Total Gastos</div>
                                <div class="info-value expense" id="expenseModalTotal">$0</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Cantidad de Gastos</div>
                                <div class="info-value" id="expenseModalCount">0</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">√öltimo Gasto</div>
                                <div class="info-value" id="expenseModalLastDate">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de gastos existentes de la placa -->
                    <div id="expensesListModal" class="expenses-list-container" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
                    
                    <!-- Formulario para agregar nuevo gasto -->
                    <div class="add-expense-form-professional">
                        <div class="expense-form-header-professional">
                            <div class="expense-form-icon-wrapper">
                                <div class="expense-form-icon">üí∞</div>
                            </div>
                            <div class="expense-form-title-section">
                                <h5 class="expense-form-title">Agregar Nuevo Gasto</h5>
                                <p class="expense-form-subtitle">Completa los datos del gasto operativo</p>
                            </div>
                        </div>
                        <div class="expense-form-grid-professional">
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üìÖ</span>
                                    <span class="label-text">Fecha del Gasto</span>
                                </label>
                                <input type="date" id="newExpenseDateModal" class="form-input-professional">
                            </div>
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üìã</span>
                                    <span class="label-text">Categor√≠a</span>
                                </label>
                                <select id="newExpenseTypeModal" class="form-input-professional form-select-professional" onchange="actualizarCamposPorCategoria()">
                                    <option value="Parqueaderos">Parqueaderos</option>
                                    <option value="Repuestos">Repuestos</option>
                                    <option value="Mano de Obra">Mano de Obra</option>
                                    <option value="Combustible">Combustible</option>
                                    <option value="Peajes">Peajes</option>
                                    <option value="Mantenimiento">Mantenimiento</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            
                            <!-- Campo de Descripci√≥n (oculto para Combustible) -->
                            <div class="form-field-professional form-field-full-professional" id="descripcionField">
                                <label class="form-label-professional">
                                    <span class="label-icon">üìù</span>
                                    <span class="label-text">Descripci√≥n del Gasto</span>
                                </label>
                                <input type="text" id="newExpenseDescriptionModal" class="form-input-professional" placeholder="Ej: Reparaci√≥n de frenos, cambio de aceite, etc.">
                            </div>
                            
                            <!-- Campo de Galones (solo para Combustible) -->
                            <div class="form-field-professional" id="galonesField" style="display: none;">
                                <label class="form-label-professional">
                                    <span class="label-icon">‚õΩ</span>
                                    <span class="label-text">Galones</span>
                                </label>
                                <div class="expense-input-wrapper-professional">
                                    <input type="number" id="newExpenseGalonesModal" class="expense-input-professional" placeholder="0" min="0" step="0.1">
                                    <span class="expense-unit-professional">gal</span>
                                </div>
                            </div>
                            
                            <!-- Campo de Fecha Final (solo para Parqueaderos) -->
                            <div class="form-field-professional" id="fechaFinalField" style="display: none;">
                                <label class="form-label-professional">
                                    <span class="label-icon">üìÖ</span>
                                    <span class="label-text">Fecha Final</span>
                                </label>
                                <input type="date" id="newExpenseFechaFinalModal" class="form-input-professional">
                                <small class="field-hint" id="diasParqueoHint" style="display: none; color: #6c757d; font-size: 0.85em; margin-top: 4px;"></small>
                            </div>
                            
                            <div class="form-field-professional">
                                <label class="form-label-professional">
                                    <span class="label-icon">üí∞</span>
                                    <span class="label-text">Valor (COP)</span>
                                </label>
                                <div class="expense-input-wrapper-professional">
                                    <span class="expense-currency-professional">$</span>
                                    <input type="number" id="newExpenseValueModal" class="expense-input-professional" placeholder="0" min="0" step="1000">
                                </div>
                            </div>
                            <div class="form-field-actions-professional">
                                <button id="addExpenseBtnModal" class="btn-add-expense-professional">
                                    <span class="btn-icon">‚ûï</span>
                                    <span class="btn-text">Agregar Gasto</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acci√≥n del modal -->
                    <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn-cancel" onclick="closeExpensesModal()">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Gesti√≥n de Pagos -->
        <div id="paymentsModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 id="paymentsModalTitle">üí∞ Gesti√≥n de Pagos</h3>
                    <span class="close" onclick="closePaymentsModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- Informaci√≥n del conductor -->
                    <div class="payment-header-info">
                        <div class="info-card">
                            <div class="info-label">Conductor</div>
                            <div class="info-value" id="paymentConductorName">-</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Total Pagado</div>
                            <div class="info-value income" id="paymentTotalPaid">$0</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Total Pendiente</div>
                            <div class="info-value expense" id="paymentTotalPending">$0</div>
                        </div>
                    </div>

                    <!-- Formulario de pago -->
                    <div class="payment-form-section" style="margin: 24px 0;">
                        <h4>üí≥ Seleccionar Viajes para Pagar</h4>
                        <div class="payment-date-input">
                            <label for="paymentDateInput">Fecha de Pago:</label>
                            <input type="date" id="paymentDateInput" class="form-input" value="">
                        </div>
                    </div>

                    <!-- Tabla de viajes pendientes -->
                    <div class="payment-table-section">
                        <h4>üìã Viajes del Conductor</h4>
                        <div class="table-container" id="pendientesTableContainer"></div>
                    </div>

                    <!-- Resumen de selecci√≥n -->
                    <div class="payment-summary-section" id="paymentSummarySection" style="display: none; margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                        <h4>üìä Resumen de Selecci√≥n</h4>
                        <div class="summary-info">
                            <span>Viajes seleccionados: <strong id="selectedCount">0</strong></span>
                            <span>Total a pagar: <strong id="selectedTotal">$0</strong></span>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="payment-actions" style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn-cancel" onclick="closePaymentsModal()">Cancelar</button>
                        <button class="process-btn" id="printDebtLetterBtn" onclick="printConductorDebtLetter()">üñ®Ô∏è Imprimir Carta</button>
                        <button class="process-btn" id="confirmPaymentBtn" onclick="confirmPayments()" style="display: none;">üíæ Confirmar Pago</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Variables globales
    let allData = null;
    let monthsData = {};
    let currentMonthIndex = 0;
    let monthsList = [];
    let gastosTotales = null;

    async function fetchData(query = '') {
        const url = query ? `/api/operacionesmanifiestos?q=${encodeURIComponent(query)}&all_data=true` : '/api/operacionesmanifiestos?all_data=true';
        const res = await fetch(url);
        const json = await res.json();
        if (!json.success) {
            throw new Error(json.error || 'Error al cargar datos');
        }
        return json.data;
    }

    // Funci√≥n helper para convertir strings de Python a JSON v√°lido
    function convertPythonStringToArray(pythonString) {
        try {
            console.log('Convirtiendo string de Python:', pythonString.substring(0, 100) + '...');
            
            // El string parece ser una representaci√≥n de array Python, necesitamos limpiarlo
            let cleanString = pythonString.trim();
            
            // Reemplazar comillas simples por comillas dobles para JSON v√°lido
            cleanString = cleanString.replace(/'/g, '"');
            
            // Reemplazar valores booleanos de Python
            cleanString = cleanString.replace(/True/g, 'true');
            cleanString = cleanString.replace(/False/g, 'false');
            cleanString = cleanString.replace(/None/g, 'null');
            
            console.log('String limpio:', cleanString.substring(0, 100) + '...');
            
            const result = JSON.parse(cleanString);
            console.log('Conversi√≥n exitosa:', result.length, 'elementos');
            return result;
        } catch (e) {
            console.error('Error al convertir string de Python:', e);
            console.error('String original:', pythonString.substring(0, 200) + '...');
            
            // Intentar una conversi√≥n m√°s agresiva
            try {
                console.log('Intentando conversi√≥n alternativa...');
                let altString = pythonString.trim();
                
                // Reemplazar comillas simples por comillas dobles
                altString = altString.replace(/'/g, '"');
                
                // Reemplazar valores booleanos
                altString = altString.replace(/True/g, 'true');
                altString = altString.replace(/False/g, 'false');
                altString = altString.replace(/None/g, 'null');
                
                // Usar eval como √∫ltimo recurso (solo para datos confiables)
                const result = eval('(' + altString + ')');
                console.log('Conversi√≥n alternativa exitosa:', result.length, 'elementos');
                return result;
            } catch (e2) {
                console.error('Error en conversi√≥n alternativa:', e2);
                return null;
            }
        }
    }

    function organizeDataByMonth(aggregates) {
        console.log('organizeDataByMonth recibi√≥:', typeof aggregates, aggregates);
        
        // Si aggregates es string, intentar convertirlo a array
        if (typeof aggregates === 'string') {
            aggregates = convertPythonStringToArray(aggregates);
            if (!aggregates) {
                monthsData = {};
                monthsList = [];
                return;
            }
            console.log('Aggregates convertido de string a array:', aggregates.length, 'elementos');
        }
        
        // Verificar que aggregates sea un array
        if (!aggregates || !Array.isArray(aggregates) || aggregates.length === 0) {
            console.error('No hay datos agregados v√°lidos para organizar:', aggregates);
            monthsData = {};
            monthsList = [];
            return;
        }
        
        monthsData = {};
        monthsList = [];
        
        aggregates.forEach(item => {
            const month = item.mes;
            if (!monthsData[month]) {
                monthsData[month] = [];
                monthsList.push(month);
            }
            monthsData[month].push(item);
        });
        
        // Ordenar meses
        monthsList.sort();
        console.log('Meses organizados:', monthsList);
        console.log('Datos por mes:', monthsData);
    }

    async function updateMonthNavigation() {
        const currentMonthElement = document.getElementById('currentMonth');
        const monthStatsElement = document.getElementById('monthStats');
        const prevBtn = document.getElementById('prevMonthBtn');
        const nextBtn = document.getElementById('nextMonthBtn');
        
        if (monthsList.length === 0) {
            currentMonthElement.textContent = 'Sin datos';
            monthStatsElement.textContent = '0 placas';
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
        }
        
        const currentMonth = monthsList[currentMonthIndex];
        const platesInMonth = monthsData[currentMonth] || [];
        
        currentMonthElement.textContent = currentMonth;
        monthStatsElement.textContent = `${platesInMonth.length} placas`;
        
        prevBtn.disabled = currentMonthIndex === 0;
        nextBtn.disabled = currentMonthIndex === monthsList.length - 1;
        
        renderPlatesForCurrentMonth();
        
        // Actualizar placas de veh√≠culos cuando cambia de mes
        await renderizarPlacasVehiculos();
        
        // Actualizar placas de gastos cuando cambia de mes
        await renderizarPlacasGastos();
        
        // Actualizar el resumen financiero cuando cambia de mes
        await actualizarResumenFinanciero();
    }

    function renderPlatesForCurrentMonth() {
        const container = document.getElementById('platesContainer');
        if (!container) return;
        
        if (monthsList.length === 0) {
            container.innerHTML = '<div class="loading-plates">No hay datos disponibles</div>';
            return;
        }
        
        const currentMonth = monthsList[currentMonthIndex];
        const platesInMonth = monthsData[currentMonth] || [];
        
        if (platesInMonth.length === 0) {
            container.innerHTML = '<div class="loading-plates">No hay placas para este mes</div>';
            return;
        }
        
        let html = '';
        platesInMonth.forEach(plate => {
            // Verificar si hay conductor v√°lido
            let conductor = plate.conductor || 'Sin Conductor';
            const hasValidConductor = conductor && conductor !== '' && conductor !== 'NaN' && conductor !== 'None' && conductor.toLowerCase() !== 'sin conductor';
            
            // Si no hay conductor v√°lido, usar "Sin Conductor"
            if (!hasValidConductor) {
                conductor = 'Sin Conductor';
            }
            
            html += `
                <div class="plate-card">
                    <div onclick="showPlateDetails('${currentMonth}', '${plate.placa}')" style="cursor: pointer;">
                        <div class="plate-header">
                            <div class="plate-name">${plate.placa}</div>
                            <div class="plate-icon">üöõ</div>
                        </div>
                        <div class="plate-stats">
                            <div class="stat-item">
                                <div class="stat-label">Viajes</div>
                                <div class="stat-value">${plate.cantidad}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Total</div>
                                <div class="stat-value amount">$${Number(plate.total_ganancia || 0).toLocaleString('es-CO')}</div>
                            </div>
                        </div>
                    </div>
                    <div class="plate-actions" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef; display: flex; gap: 8px;">
                        <button class="process-btn" data-conductor="${conductor.replace(/"/g, '&quot;')}" style="flex: 1; padding: 8px 12px; font-size: 14px;">
                            üí∞ Ver Pagos
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Agregar event listeners a los botones de pagos
        const paymentButtons = container.querySelectorAll('.process-btn[data-conductor]');
        paymentButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                const conductor = this.getAttribute('data-conductor');
                console.log('Bot√≥n de pagos clickeado para conductor:', conductor);
                openPaymentsModal(conductor);
            });
        });
    }

    async function showPlateDetails(month, plate) {
        console.log(`Mostrando detalles para ${plate} en ${month}`);
        
        // Verificar que allData est√© disponible
        if (!allData || allData.length === 0) {
            alert('No hay datos disponibles para mostrar detalles');
            return;
        }
        
        // Si allData es string, intentar convertirlo a array
        if (typeof allData === 'string') {
            allData = convertPythonStringToArray(allData);
            if (!allData) {
                alert('Error al procesar los datos');
                return;
            }
            console.log('All data convertido de string a array:', allData.length, 'elementos');
        }
        
        // Buscar todos los viajes de esta placa en este mes
        const trips = allData.filter(trip => 
            trip.mes === month && trip.placa === plate
        );
        
        if (trips.length === 0) {
            alert('No se encontraron viajes para esta placa en este mes');
            return;
        }
        
        // Obtener datos de pagos para crear mapa de estados por load_id
        let pagosMap = {}; // Mapa: load_id -> {estado_manifiesto, estado_conductor, tarifa}
        try {
            const response = await fetch('/api/resumen-pagos');
            const data = await response.json();
            if (data.success && data.resumen) {
                // Recorrer todos los conductores y sus viajes
                Object.values(data.resumen).forEach(conductorData => {
                    if (conductorData.viajes_detalle) {
                        conductorData.viajes_detalle.forEach(viaje => {
                            const loadId = String(viaje.load_id || '').trim();
                            if (loadId) {
                                pagosMap[loadId] = {
                                    estado_manifiesto: viaje.manifiesto_pagado || 'PENDIENTE',  // Estado del manifiesto
                                    estado_conductor: viaje.estado || 'PENDIENTE',  // Estado de pago al conductor
                                    tarifa: Number(viaje.tarifa || 0)
                                };
                            }
                        });
                    }
                });
            }
        } catch (error) {
            console.warn('Error al obtener datos de pagos:', error);
        }
        
        // Calcular estad√≠sticas
        const totalTrips = trips.length;
        const totalAmount = trips.reduce((sum, trip) => sum + (Number(trip.valormanifiesto) || 0), 0);
        const avgAmount = totalAmount / totalTrips;
        
        // Calcular total pagado basado en los viajes que tienen manifiesto PAGADO
        // Usar el valor del manifiesto (valor), no la tarifa del conductor
        let totalPagado = 0;
        trips.forEach(trip => {
            const loadId = String(trip.load_id || trip.ID || trip['load_id'] || '').trim();
            const pagoInfo = pagosMap[loadId];
            // Usar estado_manifiesto para determinar si el manifiesto est√° pagado
            if (pagoInfo && pagoInfo.estado_manifiesto === 'PAGADO') {
                // Usar el valor del manifiesto, no la tarifa del conductor
                const valor = trip.valormanifiesto || trip['VALOR FLETE'] || 0;
                totalPagado += Number(valor) || 0;
            }
        });
        
        // Mostrar modal
        const modal = document.getElementById('tripsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSummary = document.getElementById('modalSummary');
        const modalTable = document.getElementById('modalTable');
        
        modalTitle.textContent = `Viajes de ${plate} - ${month}`;
        
        modalSummary.innerHTML = `
            <h4>Resumen de Viajes</h4>
            <div class="summary-stats" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="summary-stat">
                    <div class="label">Total Viajes</div>
                    <div class="value" style="font-size: 1.4em;">${totalTrips}</div>
                </div>
                <div class="summary-stat">
                    <div class="label">Total Ganancia</div>
                    <div class="value amount" style="font-size: 1.3em;">$${totalAmount.toLocaleString('es-CO')}</div>
                </div>
                <div class="summary-stat">
                    <div class="label">Dinero Pagados</div>
                    <div class="value amount" style="color: #28a745; font-size: 1.3em;">$${totalPagado.toLocaleString('es-CO')}</div>
                </div>
                <div class="summary-stat">
                    <div class="label">Promedio por Viaje</div>
                    <div class="value amount" style="font-size: 1.3em;">$${avgAmount.toLocaleString('es-CO')}</div>
                </div>
            </div>
        `;
        
         // Crear tabla de detalles simplificada con campos esenciales
         // Ajustar anchos de columnas seg√∫n el contenido
         let tableHtml = '<table class="dynamic-table" style="table-layout: auto; width: 100%;"><thead><tr>' +
             '<th style="width: 70px; min-width: 70px;">PDF</th>' +
             '<th style="width: 110px; min-width: 110px;">Load ID</th>' +
             '<th style="width: 130px; min-width: 130px;">Fecha Inicio</th>' +
             '<th style="min-width: 180px;">Destino</th>' +
             '<th style="width: 130px; min-width: 130px; text-align: right;">Valor</th>' +
             '<th style="width: 130px; min-width: 130px;">Manifiesto Pagado</th>' +
             '<th style="width: 130px; min-width: 130px;">Pago Conductor</th>' +
             '<th style="width: 160px; min-width: 160px;">Acci√≥n</th>' +
             '</tr></thead><tbody>';
         
         trips.forEach(trip => {
             // Debug: mostrar las claves disponibles en el objeto trip
             console.log('Campos disponibles en trip:', Object.keys(trip));
             console.log('Trip completo:', trip);
             
             // Manejar diferentes nombres de campos
             const loadId = trip.load_id || trip.ID || trip['load_id'] || '';
             const fechaInicio = trip['fecha inicio'] || trip['FECHA VIAJE'] || trip.fecha_inicio || '';
             const destino = trip.destino || '';
             const valor = trip.valormanifiesto || trip['VALOR FLETE'] || 0;
             const archivo = trip.archivo || trip['ARCHIVO PDF'] || trip.filename || '';
             
             // Obtener estados de pago (manifiesto y conductor)
             const loadIdStr = String(loadId).trim();
             const pagoInfo = pagosMap[loadIdStr];
             
             // Estado del manifiesto (pago del cliente)
             const estadoManifiesto = pagoInfo ? (pagoInfo.estado_manifiesto || 'PENDIENTE') : 'PENDIENTE';
             const estadoManifiestoClass = estadoManifiesto === 'PAGADO' ? 'estado-pagado' : 'estado-pendiente';
             const estadoManifiestoText = estadoManifiesto === 'PAGADO' ? '‚úÖ PAGADO' : '‚è≥ PENDIENTE';
             
             // Estado de pago al conductor
             const estadoConductor = pagoInfo ? (pagoInfo.estado_conductor || 'PENDIENTE') : 'PENDIENTE';
             const estadoConductorClass = estadoConductor === 'PAGADO' ? 'estado-pagado' : 'estado-pendiente';
             const estadoConductorText = estadoConductor === 'PAGADO' ? '‚úÖ PAGADO' : '‚è≥ PENDIENTE';
             
             // Bot√≥n para marcar manifiesto como pagado (solo si est√° pendiente)
             // Escapar comillas simples en los par√°metros
             const loadIdEscaped = loadIdStr.replace(/'/g, "\\'");
             const monthEscaped = month.replace(/'/g, "\\'");
             const plateEscaped = plate.replace(/'/g, "\\'");
             
             const botonAccion = estadoManifiesto === 'PENDIENTE' 
                 ? `<button class="btn-action pay-btn" onclick="marcarComoPagado('${loadIdEscaped}', '${monthEscaped}', '${plateEscaped}')" title="Marcar Manifiesto como Pagado">
                        üí∞ Marcar Manifiesto Pagado
                    </button>`
                 : '<span style="color: #28a745; font-weight: 600;">‚úì Manifiesto Pagado</span>';
             
             tableHtml += `
                 <tr>
                     <td style="text-align: center; padding: 8px;">
                         <button class="btn-action view-btn" onclick="openPDF('${archivo}')" title="Ver PDF">
                             üëÅÔ∏è
                         </button>
                     </td>
                     <td style="font-weight: 600; color: #495057;">${loadId}</td>
                     <td>${fechaInicio}</td>
                     <td title="${destino}" style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${destino}</td>
                     <td style="text-align: right; font-weight: 600; color: #28a745; font-size: 0.95em;">$${Number(valor || 0).toLocaleString('es-CO')}</td>
                     <td class="${estadoManifiestoClass}" style="text-align: center; font-weight: 600; font-size: 0.9em;">${estadoManifiestoText}</td>
                     <td class="${estadoConductorClass}" style="text-align: center; font-weight: 600; font-size: 0.9em;">${estadoConductorText}</td>
                     <td style="text-align: center; padding: 8px;">${botonAccion}</td>
                 </tr>
             `;
         });
        
        tableHtml += '</tbody></table>';
        modalTable.innerHTML = tableHtml;
        
        modal.style.display = 'block';
    }
    
    // Funci√≥n para marcar un viaje como pagado (manifiesto pagado por el cliente)
    async function marcarComoPagado(loadId, month, plate) {
        if (!confirm(`¬øMarcar el manifiesto ${loadId} como PAGADO? (Esto indica que el cliente pag√≥ el manifiesto)`)) {
            return;
        }
        
        // Obtener fecha actual
        const today = new Date().toISOString().split('T')[0];
        
        try {
            const response = await fetch('/api/pagos-actualizar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    load_ids: [loadId],
                    estado_pago: 'PAGADO',
                    fecha_pago: today,
                    tipo_pago: 'manifiesto'  // Indicar que es pago del manifiesto, no del conductor
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('‚úì Viaje marcado como pagado correctamente');
                // Refrescar el modal con los nuevos datos
                await showPlateDetails(month, plate);
                // Actualizar el resumen financiero
                await actualizarGastosTotales();
                await actualizarResumenFinanciero();
            } else {
                alert('Error al marcar como pagado: ' + (data.error || 'Error desconocido'));
            }
        } catch (error) {
            console.error('Error al marcar como pagado:', error);
            alert('Error al marcar como pagado: ' + error.message);
        }
    }

    function closeTripsModal() {
        const modal = document.getElementById('tripsModal');
        modal.style.display = 'none';
    }

    // Funci√≥n para abrir PDF
    function openPDF(filepath) {
        if (filepath && filepath !== 'N/A' && filepath !== '') {
            // Si es una ruta completa, extraer solo el nombre del archivo
            const filename = filepath.includes('/') ? filepath.split('/').pop() : filepath;
            const filename2 = filename.includes('\\') ? filename.split('\\').pop() : filename;
            window.open(`/open_pdf/${filename2}`, '_blank');
        } else {
            alert('No hay archivo PDF disponible');
        }
    }

    // Funci√≥n para buscar PDF por Load ID
    function searchPDFByLoadId(loadId) {
        if (!loadId || loadId === 'N/A' || loadId === '') {
            alert('No hay Load ID disponible para buscar el PDF');
            return;
        }
        
        // Buscar PDF en todas las carpetas de MANIFIESTOS
        window.open(`/search_pdf/${encodeURIComponent(loadId)}`, '_blank');
    }

    function calcularIngresosTotales() {
        if (!allData || allData.length === 0) return 0;
        
        let totalIngresos = 0;
        allData.forEach(manifiesto => {
            const valor = manifiesto.valormanifiesto || manifiesto['VALOR FLETE'] || 0;
            totalIngresos += Number(valor) || 0;
        });
        
        return totalIngresos;
    }
    
    // Calcular total de dinero de manifiestos pagados
    async function calcularManifiestosPagados() {
        if (!allData || allData.length === 0) return 0;
        if (!monthsList || monthsList.length === 0) return 0;
        
        const currentMonth = monthsList[currentMonthIndex];
        if (!currentMonth) return 0;
        
        // Filtrar datos del mes actual
        const datosMesActual = allData.filter(item => item.mes === currentMonth);
        
        // Obtener datos de pagos para crear mapa de estados por load_id
        let pagosMap = {}; // Mapa: load_id -> {estado_manifiesto, estado_conductor, tarifa}
        try {
            const response = await fetch('/api/resumen-pagos');
            const data = await response.json();
            if (data.success && data.resumen) {
                // Recorrer todos los conductores y sus viajes
                Object.values(data.resumen).forEach(conductorData => {
                    if (conductorData.viajes_detalle) {
                        conductorData.viajes_detalle.forEach(viaje => {
                            const loadId = String(viaje.load_id || '').trim();
                            if (loadId) {
                                pagosMap[loadId] = {
                                    estado_manifiesto: viaje.manifiesto_pagado || 'PENDIENTE',  // Estado del manifiesto
                                    estado_conductor: viaje.estado || 'PENDIENTE',  // Estado de pago al conductor
                                    tarifa: Number(viaje.tarifa || 0)
                                };
                            }
                        });
                    }
                });
            }
        } catch (error) {
            console.warn('Error al obtener datos de pagos para calcular manifiestos pagados:', error);
        }
        
        // Calcular total de dinero de manifiestos pagados
        let totalManifiestosPagados = 0;
        datosMesActual.forEach(manifiesto => {
            const loadId = String(manifiesto.load_id || manifiesto.ID || manifiesto['load_id'] || '').trim();
            const pagoInfo = pagosMap[loadId];
            
            // Si el manifiesto est√° marcado como PAGADO, sumar el valor del manifiesto
            // Usar estado_manifiesto, no estado_conductor
            if (pagoInfo && pagoInfo.estado_manifiesto === 'PAGADO') {
                const valor = manifiesto.valormanifiesto || manifiesto['VALOR FLETE'] || 0;
                totalManifiestosPagados += Number(valor) || 0;
            }
        });
        
        return totalManifiestosPagados;
    }
    
    // Funci√≥n para obtener los destinos y sus tarifas actuales
    async function obtenerTarifasActuales() {
        try {
            const response = await fetch('/api/destinos-tarifas');
            const data = await response.json();
            
            if (data.success && data.destinos) {
                const tarifas = {};
                data.destinos.forEach(d => {
                    tarifas[d.destino] = d.tarifa || 0;
                });
                console.log(`Tarifas cargadas (${Object.keys(tarifas).length} destinos):`, tarifas);
                return tarifas;
            }
        } catch (error) {
            console.error('Error al cargar tarifas:', error);
        }
        return {};
    }
    
    // Calcular gastos de conductores bas√°ndose en el mes actual
    async function calcularGastosConductoresMesActual() {
        if (!allData || allData.length === 0) return 0;
        if (!monthsList || monthsList.length === 0) return 0;
        
        const currentMonth = monthsList[currentMonthIndex];
        if (!currentMonth) return 0;
        
        // Filtrar datos del mes actual
        const datosMesActual = allData.filter(item => item.mes === currentMonth);
        
        console.log(`Calculando gastos para mes: ${currentMonth}`);
        console.log(`Total viajes en el mes: ${datosMesActual.length}`);
        
        // Cargar tarifas actuales
        const tarifas = await obtenerTarifasActuales();
        
        // Obtener destinos √∫nicos para mostrar
        const destinosUnicos = [...new Set(datosMesActual.map(d => d.destino))];
        console.log(`Destinos √∫nicos en el mes:`, destinosUnicos);
        
        let totalGastosConductores = 0;
        
        datosMesActual.forEach(manifiesto => {
            const destino = manifiesto.destino || '';
            if (destino) {
                // Normalizar destino para b√∫squeda
                const destinoNormalizado = destino.trim();
                const destinoUpper = destinoNormalizado.toUpperCase();
                
                // Buscar tarifa exacta (primero intentar sin normalizar, luego con normalizaci√≥n)
                let tarifaEncontrada = tarifas[destino] || 
                                       tarifas[destinoNormalizado] ||
                                       tarifas[destinoUpper];
                
                // Si no encuentra tarifa exacta, buscar coincidencias parciales
                if (!tarifaEncontrada) {
                    for (const [ciudad, precio] of Object.entries(tarifas)) {
                        const ciudadUpper = ciudad.toUpperCase();
                        // Buscar si alguna ciudad incluye el destino o viceversa
                        if (ciudadUpper === destinoUpper || 
                            ciudadUpper.includes(destinoUpper) || 
                            destinoUpper.includes(ciudadUpper)) {
                            tarifaEncontrada = precio;
                            break;
                        }
                    }
                }
                
                // Si a√∫n no encuentra, intentar b√∫squeda m√°s flexible
                if (!tarifaEncontrada) {
                    // Dividir destino por palabras y buscar coincidencias
                    const palabrasDestino = destinoUpper.split(/[\s,-]+/);
                    for (const palabra of palabrasDestino) {
                        if (palabra.length > 3) { // Solo palabras significativas
                            for (const [ciudad, precio] of Object.entries(tarifas)) {
                                if (ciudad.toUpperCase().includes(palabra)) {
                                    tarifaEncontrada = precio;
                                    break;
                                }
                            }
                            if (tarifaEncontrada) break;
                        }
                    }
                }
                
                // Si a√∫n no encuentra, usar tarifa por defecto m√°s conservadora
                if (!tarifaEncontrada) {
                    tarifaEncontrada = 75000; // Tarifa por defecto m√°s conservadora
                    console.warn(`No se encontr√≥ tarifa para destino: ${destino}. Usando tarifa por defecto: $75,000`);
                }
                
                totalGastosConductores += tarifaEncontrada;
                
                // Debug: mostrar qu√© tarifa se us√≥
                console.log(`Destino: ${destino}, Tarifa aplicada: $${tarifaEncontrada.toLocaleString('es-CO')}`);
            }
        });
        
        console.log(`Total gastos conductores para ${currentMonth}: $${totalGastosConductores.toLocaleString('es-CO')}`);
        
        return totalGastosConductores;
    }

    async function actualizarResumenFinanciero() {
        const totalIngresos = calcularIngresosTotales();
        
        // Calcular total de dinero de manifiestos pagados
        const totalManifiestosPagados = await calcularManifiestosPagados();
        
        // Calcular total de gastos incluyendo todos los componentes
        let totalGastos = 0;
        
        if (gastosTotales) {
            // Gastos en conductores - calcular bas√°ndose en los datos del mes actual
            const gastosConductores = await calcularGastosConductoresMesActual();
            
            // Gastos adicionales desde la lista din√°mica - solo del mes actual
            const currentMonth = monthsList[currentMonthIndex] || '';
            const gastosAdicionalesMes = gastosAdicionalesList.filter(gasto => {
                // Si el gasto tiene placa, verificar que la placa est√© en el mes actual
                if (gasto.placa) {
                    const platesInMonth = monthsData[currentMonth] || [];
                    return platesInMonth.some(p => p.placa === gasto.placa);
                }
                // Si no tiene placa, incluir (compatibilidad con formato antiguo)
                return true;
            });
            const totalGastosAdicionales = gastosAdicionalesMes.reduce((sum, gasto) => sum + (gasto.valor || 0), 0);
            
            // Sumar todo
            totalGastos = gastosConductores + totalGastosAdicionales;
            
            // Actualizar el desglose con los gastos de conductores calculados
            document.getElementById('expensesDrivers').textContent = `$${gastosConductores.toLocaleString('es-CO')}`;
            
            // Calcular total pagado en conductores
            const totalPagado = gastosTotales.pagos_realizados ? 
                gastosTotales.pagos_realizados.reduce((sum, p) => sum + (p.monto || 0), 0) : 0;
            
            // Calcular total pendiente (total - pagado)
            const totalPendiente = gastosConductores - totalPagado;
            
            document.getElementById('expensesDriversPaid').textContent = `$${totalPagado.toLocaleString('es-CO')}`;
            document.getElementById('expensesDriversPending').textContent = `$${totalPendiente.toLocaleString('es-CO')}`;
            
            // Calcular gastos adicionales por categor√≠a desde la lista din√°mica (solo del mes actual)
            const gastosParking = gastosAdicionalesMes
                .filter(g => g.tipo === 'Parqueaderos')
                .reduce((sum, g) => sum + (g.valor || 0), 0);
            const gastosParts = gastosAdicionalesMes
                .filter(g => g.tipo === 'Repuestos')
                .reduce((sum, g) => sum + (g.valor || 0), 0);
            const gastosLabor = gastosAdicionalesMes
                .filter(g => g.tipo === 'Mano de Obra')
                .reduce((sum, g) => sum + (g.valor || 0), 0);
            
            // Actualizar valores en el desglose (usar gastos desde la lista)
            document.getElementById('expensesParking').textContent = `$${gastosParking.toLocaleString('es-CO')}`;
            document.getElementById('expensesParts').textContent = `$${gastosParts.toLocaleString('es-CO')}`;
            document.getElementById('expensesLabor').textContent = `$${gastosLabor.toLocaleString('es-CO')}`;
            
            // Mostrar lista de pagos realizados
            mostrarPagosRealizados(gastosTotales.pagos_realizados || []);
        }
        
        // Calcular utilidad neta usando el dinero de manifiestos pagados, no los ingresos totales
        const utilidadNeta = totalManifiestosPagados - totalGastos;
        
        // Actualizar tarjetas principales
        document.getElementById('totalIncome').textContent = `$${totalIngresos.toLocaleString('es-CO')}`;
        document.getElementById('totalExpenses').textContent = `$${totalGastos.toLocaleString('es-CO')}`;
        document.getElementById('totalManifiestosPagados').textContent = `$${totalManifiestosPagados.toLocaleString('es-CO')}`;
        
        // Actualizar utilidad neta con color seg√∫n resultado
        const netProfitElement = document.getElementById('netProfit');
        netProfitElement.textContent = `$${utilidadNeta.toLocaleString('es-CO')}`;
        
        // Cambiar color seg√∫n si es ganancia o p√©rdida
        if (utilidadNeta >= 0) {
            netProfitElement.style.color = '#28a745'; // Verde para ganancia
        } else {
            netProfitElement.style.color = '#dc3545'; // Rojo para p√©rdida
        }
    }
    
    // Funci√≥n para mostrar los pagos realizados
    function mostrarPagosRealizados(pagos) {
        const container = document.getElementById('paymentsListContainer');
        
        if (!pagos || pagos.length === 0) {
            container.innerHTML = '<div class="table-empty" style="padding: 40px; text-align: center; color: #6c757d; font-style: italic;">No hay pagos realizados a√∫n</div>';
            return;
        }
        
        let html = '<div class="payments-cards-grid">';
        
        // Agrupar pagos por conductor y fecha (ordenar por fecha primero)
        const pagosPorConductor = {};
        pagos.forEach(pago => {
            const conductor = pago.conductor || 'Sin conductor';
            if (!pagosPorConductor[conductor]) {
                pagosPorConductor[conductor] = [];
            }
            pagosPorConductor[conductor].push(pago);
        });
        
        // Ordenar conductores por fecha (m√°s reciente primero)
        const conductoresOrdenados = Object.keys(pagosPorConductor).sort((a, b) => {
            const fechaA = pagosPorConductor[a][0]?.fecha_pago || '';
            const fechaB = pagosPorConductor[b][0]?.fecha_pago || '';
            return fechaB.localeCompare(fechaA);
        });
        
        // Renderizar tarjetas
        conductoresOrdenados.forEach((conductor, index) => {
            const pagosConductor = pagosPorConductor[conductor];
            const totalConductor = pagosConductor.reduce((sum, p) => sum + (p.monto || 0), 0);
            const primeraFecha = pagosConductor[0]?.fecha_pago || 'Sin fecha';
            
            html += `
                <div class="payment-card" onclick="togglePaymentDetails(${index})">
                    <div class="payment-card-header">
                        <div class="payment-card-icon">üí∞</div>
                        <div class="payment-card-info">
                            <div class="payment-card-date">üìÖ ${primeraFecha}</div>
                            <div class="payment-card-name">${conductor}</div>
                        </div>
                        <div class="payment-card-amount">$${totalConductor.toLocaleString('es-CO')}</div>
                        <div class="payment-card-arrow" id="arrow-${index}">‚ñº</div>
                    </div>
                    <div class="payment-card-details" id="details-${index}" style="display: none;">
                        <div class="payment-details-list">
            `;
            
            pagosConductor.forEach((pago, pindex) => {
                html += `
                    <div class="payment-detail-item">
                        <div class="payment-detail-info">
                            <span class="payment-detail-label">Load ID:</span>
                            <span class="payment-detail-value">${pago.load_id}</span>
                        </div>
                        <div class="payment-detail-info">
                            <span class="payment-detail-label">Destino:</span>
                            <span class="payment-detail-value">${pago.destino || 'N/A'}</span>
                        </div>
                        <div class="payment-detail-info highlight">
                            <span class="payment-detail-label">Monto:</span>
                            <span class="payment-detail-value">$${Number(pago.monto || 0).toLocaleString('es-CO')}</span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // Funci√≥n para expandir/colapsar detalles de pago
    function togglePaymentDetails(index) {
        const details = document.getElementById(`details-${index}`);
        const arrow = document.getElementById(`arrow-${index}`);
        
        if (!details || !arrow) return;
        
        if (details.style.display === 'none' || details.style.display === '') {
            details.style.display = 'block';
            arrow.textContent = '‚ñ≤';
            arrow.classList.add('rotated');
        } else {
            details.style.display = 'none';
            arrow.textContent = '‚ñº';
            arrow.classList.remove('rotated');
        }
    }

    async function actualizarGastosTotales() {
        try {
            // Obtener el mes actual usando la variable global
            if (monthsList.length === 0) {
                console.log('No hay meses disponibles para actualizar gastos');
                return;
            }
            
            const currentMonth = monthsList[currentMonthIndex];
            const response = await fetch(`/api/operaciones/${currentMonth}`);
            const data = await response.json();
            
            if (data.success && data.gastos_totales) {
                // Actualizar la variable global de gastos
                gastosTotales = data.gastos_totales;
                
                // Recalcular el resumen financiero
                await actualizarResumenFinanciero();
                
                console.log('Gastos actualizados para', currentMonth, ':', gastosTotales);
            }
        } catch (error) {
            console.error('Error al actualizar gastos:', error);
        }
    }

    // Variable global para los gastos adicionales
    let gastosAdicionalesList = [];
    let currentPlacaExpenses = null; // Placa actual en el modal
    
    // Variable global para los veh√≠culos
    let vehiculosList = {};
    let currentPlacaVehicle = null; // Placa actual en el modal de veh√≠culo

    async function cargarGastosAdicionales() {
        try {
            const response = await fetch('/api/gastos-adicionales');
            const data = await response.json();
            
            if (data.success && data.gastos) {
                // Si es el formato antiguo, convertir a nuevo formato
                if (Array.isArray(data.gastos)) {
                    // Ya es una lista, asegurar que tenga todos los campos necesarios
                    gastosAdicionalesList = data.gastos.map(gasto => {
                        // Si no tiene 'tipo' pero tiene 'descripcion', es formato intermedio
                        if (!gasto.tipo && gasto.descripcion) {
                            return {
                                fecha: gasto.fecha,
                                tipo: gasto.descripcion,
                                descripcion: '',
                                valor: gasto.valor,
                                placa: gasto.placa || '' // Agregar placa si no existe
                            };
                        }
                        // Asegurar que tenga placa y preservar campos adicionales (galones, fecha_final, dias, etc.)
                        return {
                            ...gasto,
                            placa: gasto.placa || '',
                            galones: gasto.galones || null,
                            fecha_final: gasto.fecha_final || null,
                            dias: gasto.dias || null,
                            descripcion: gasto.descripcion || ''
                        };
                    });
                } else {
                    // Formato m√°s antiguo: dict con parqueaderos, repuestos, mano_obra
                    gastosAdicionalesList = [];
                    if (data.gastos.parqueaderos) {
                        gastosAdicionalesList.push({
                            fecha: new Date().toISOString().split('T')[0],
                            tipo: 'Parqueaderos',
                            descripcion: '',
                            valor: parseFloat(data.gastos.parqueaderos) || 0,
                            placa: ''
                        });
                    }
                    if (data.gastos.repuestos) {
                        gastosAdicionalesList.push({
                            fecha: new Date().toISOString().split('T')[0],
                            tipo: 'Repuestos',
                            descripcion: '',
                            valor: parseFloat(data.gastos.repuestos) || 0,
                            placa: ''
                        });
                    }
                    if (data.gastos.mano_obra) {
                        gastosAdicionalesList.push({
                            fecha: new Date().toISOString().split('T')[0],
                            tipo: 'Mano de Obra',
                            descripcion: '',
                            valor: parseFloat(data.gastos.mano_obra) || 0,
                            placa: ''
                        });
                    }
                }
                
                renderizarPlacasGastos();
                console.log('Gastos adicionales cargados:', gastosAdicionalesList);
            }
        } catch (error) {
            console.error('Error al cargar gastos adicionales:', error);
        }
    }
    
    // ==================== FUNCIONES DE GESTI√ìN DE VEH√çCULOS ====================
    
    // Cargar veh√≠culos desde el servidor
    async function cargarVehiculos() {
        try {
            const response = await fetch('/api/vehiculos');
            const data = await response.json();
            
            if (data.success && data.vehiculos) {
                vehiculosList = data.vehiculos || {};
                renderizarPlacasVehiculos();
                console.log('Veh√≠culos cargados:', vehiculosList);
            } else {
                // Si no hay veh√≠culos, inicializar objeto vac√≠o
                vehiculosList = {};
                renderizarPlacasVehiculos();
            }
        } catch (error) {
            console.error('Error al cargar veh√≠culos:', error);
            vehiculosList = {};
            renderizarPlacasVehiculos();
        }
    }
    
    // Funci√≥n para calcular d√≠as restantes hasta una fecha
    function calcularDiasRestantes(fechaVencimiento) {
        if (!fechaVencimiento) return null;
        
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        const vencimiento = new Date(fechaVencimiento);
        vencimiento.setHours(0, 0, 0, 0);
        
        const diffTime = vencimiento - hoy;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        return diffDays;
    }
    
    // Funci√≥n para obtener el estado y clase CSS seg√∫n d√≠as restantes
    function obtenerEstadoVencimiento(dias) {
        if (dias === null) return { texto: 'Sin fecha', clase: 'status-unknown', icono: '‚ùì' };
        if (dias < 0) return { texto: `Vencido hace ${Math.abs(dias)} d√≠a(s)`, clase: 'status-expired', icono: '‚ö†Ô∏è' };
        if (dias === 0) return { texto: 'Vence hoy', clase: 'status-today', icono: 'üî¥' };
        if (dias <= 7) return { texto: `Vence en ${dias} d√≠a(s)`, clase: 'status-warning', icono: 'üü°' };
        if (dias <= 30) return { texto: `Vence en ${dias} d√≠a(s)`, clase: 'status-close', icono: 'üü†' };
        return { texto: `Vence en ${dias} d√≠a(s)`, clase: 'status-ok', icono: '‚úÖ' };
    }
    
    // Renderizar placas de veh√≠culos
    async function renderizarPlacasVehiculos() {
        const container = document.getElementById('platesVehiclesContainer');
        if (!container) return;
        
        // Obtener placas del mes actual
        if (monthsList.length === 0) {
            container.innerHTML = '<div class="loading-plates">No hay datos disponibles</div>';
            return;
        }
        
        const currentMonth = monthsList[currentMonthIndex];
        const platesInMonth = monthsData[currentMonth] || [];
        
        if (platesInMonth.length === 0) {
            container.innerHTML = '<div class="loading-plates">No hay placas para este mes</div>';
            return;
        }
        
        let html = '';
        platesInMonth.forEach(plate => {
            const placa = plate.placa;
            const vehiculo = vehiculosList[placa] || {};
            const tieneDatos = vehiculo.modelo || vehiculo.soat || vehiculo.seguro || vehiculo.tecnomecanica || vehiculo.propietario || vehiculo.valor || vehiculo.soat_valor || vehiculo.seguro_valor || vehiculo.tecnomecanica_valor;
            
            // Calcular d√≠as restantes para cada documento
            const diasSoat = calcularDiasRestantes(vehiculo.soat);
            const diasSeguro = calcularDiasRestantes(vehiculo.seguro);
            const diasTecnomecanica = calcularDiasRestantes(vehiculo.tecnomecanica);
            
            // Obtener estados
            const estadoSoat = obtenerEstadoVencimiento(diasSoat);
            const estadoSeguro = obtenerEstadoVencimiento(diasSeguro);
            const estadoTecnomecanica = obtenerEstadoVencimiento(diasTecnomecanica);
            
            html += `
                <div class="plate-vehicle-card ${tieneDatos ? 'has-data' : ''}" onclick="openVehicleModal('${placa}')">
                    <div class="plate-vehicle-header">
                        <div class="plate-vehicle-icon">üöõ</div>
                        <div class="plate-vehicle-name">${placa}</div>
                        ${tieneDatos ? '<div class="plate-vehicle-badge">‚úì</div>' : ''}
                    </div>
                    <div class="plate-vehicle-info">
                        ${vehiculo.soat ? `
                            <div class="vehicle-info-item ${estadoSoat.clase}">
                                <div class="info-left">
                                    <span class="info-icon">${estadoSoat.icono}</span>
                                    <span class="info-label">SOAT:</span>
                                </div>
                                <span class="info-value">${estadoSoat.texto}</span>
                            </div>
                        ` : ''}
                        ${vehiculo.seguro ? `
                            <div class="vehicle-info-item ${estadoSeguro.clase}">
                                <div class="info-left">
                                    <span class="info-icon">${estadoSeguro.icono}</span>
                                    <span class="info-label">Seguro:</span>
                                </div>
                                <span class="info-value">${estadoSeguro.texto}</span>
                            </div>
                        ` : ''}
                        ${vehiculo.tecnomecanica ? `
                            <div class="vehicle-info-item ${estadoTecnomecanica.clase}">
                                <div class="info-left">
                                    <span class="info-icon">${estadoTecnomecanica.icono}</span>
                                    <span class="info-label">Tecnomec√°nica:</span>
                                </div>
                                <span class="info-value">${estadoTecnomecanica.texto}</span>
                            </div>
                        ` : ''}
                        ${!tieneDatos ? '<div class="vehicle-info-empty">Sin datos registrados</div>' : ''}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Abrir modal de veh√≠culo
    function openVehicleModal(placa) {
        currentPlacaVehicle = placa;
        const modal = document.getElementById('vehicleModal');
        const modalPlaca = document.getElementById('vehicleModalPlaca');
        
        if (!modal || !modalPlaca) {
            console.error('Modal de veh√≠culo no encontrado');
            return;
        }
        
        modalPlaca.textContent = placa;
        
        // Cargar datos del veh√≠culo si existen
        const vehiculo = vehiculosList[placa] || {};
        
        document.getElementById('vehiclePlacaModal').value = placa;
        document.getElementById('vehicleModeloModal').value = vehiculo.modelo || '';
        document.getElementById('vehicleSoatModal').value = vehiculo.soat || '';
        document.getElementById('vehicleSoatValorModal').value = vehiculo.soat_valor || '';
        document.getElementById('vehicleSeguroModal').value = vehiculo.seguro || '';
        document.getElementById('vehicleSeguroValorModal').value = vehiculo.seguro_valor || '';
        document.getElementById('vehicleTecnomecanicaModal').value = vehiculo.tecnomecanica || '';
        document.getElementById('vehicleTecnomecanicaValorModal').value = vehiculo.tecnomecanica_valor || '';
        document.getElementById('vehiclePropietarioModal').value = vehiculo.propietario || '';
        document.getElementById('vehicleValorModal').value = vehiculo.valor || '';
        
        // Mostrar modal
        modal.style.display = 'block';
    }
    
    // Cerrar modal de veh√≠culo
    function closeVehicleModal() {
        const modal = document.getElementById('vehicleModal');
        if (modal) {
            modal.style.display = 'none';
        }
        currentPlacaVehicle = null;
    }
    
    // Guardar datos del veh√≠culo
    async function guardarVehiculo() {
        if (!currentPlacaVehicle) {
            alert('Error: No hay placa seleccionada');
            return;
        }
        
        const vehiculo = {
            placa: currentPlacaVehicle,
            modelo: document.getElementById('vehicleModeloModal').value.trim(),
            soat: document.getElementById('vehicleSoatModal').value,
            soat_valor: parseFloat(document.getElementById('vehicleSoatValorModal').value) || 0,
            seguro: document.getElementById('vehicleSeguroModal').value,
            seguro_valor: parseFloat(document.getElementById('vehicleSeguroValorModal').value) || 0,
            tecnomecanica: document.getElementById('vehicleTecnomecanicaModal').value,
            tecnomecanica_valor: parseFloat(document.getElementById('vehicleTecnomecanicaValorModal').value) || 0,
            propietario: document.getElementById('vehiclePropietarioModal').value.trim(),
            valor: parseFloat(document.getElementById('vehicleValorModal').value) || 0
        };
        
        // Guardar en la lista local
        vehiculosList[currentPlacaVehicle] = vehiculo;
        
        // Actualizar la vista
        await renderizarPlacasVehiculos();
        
        alert('‚úì Datos del veh√≠culo guardados correctamente');
        console.log('Veh√≠culo guardado:', vehiculo);
    }
    
    // Funci√≥n para pagar un documento (SOAT, Seguro o Tecnomec√°nica)
    async function pagarDocumento(tipoDocumento) {
        if (!currentPlacaVehicle) {
            alert('Error: No hay placa seleccionada');
            return;
        }
        
        let valorInput, fechaInput, descripcion;
        
        // Obtener el valor y fecha seg√∫n el tipo de documento
        switch(tipoDocumento) {
            case 'SOAT':
                valorInput = document.getElementById('vehicleSoatValorModal');
                fechaInput = document.getElementById('vehicleSoatModal');
                descripcion = 'Pago de SOAT';
                break;
            case 'Seguro':
                valorInput = document.getElementById('vehicleSeguroValorModal');
                fechaInput = document.getElementById('vehicleSeguroModal');
                descripcion = 'Pago de Seguro';
                break;
            case 'Tecnomec√°nica':
                valorInput = document.getElementById('vehicleTecnomecanicaValorModal');
                fechaInput = document.getElementById('vehicleTecnomecanicaModal');
                descripcion = 'Pago de Tecnomec√°nica';
                break;
            default:
                alert('Error: Tipo de documento no v√°lido');
                return;
        }
        
        const valor = parseFloat(valorInput.value) || 0;
        const fechaVencimiento = fechaInput.value;
        
        if (valor <= 0) {
            alert(`Debes ingresar un valor mayor a 0 para ${tipoDocumento}`);
            return;
        }
        
        if (!fechaVencimiento) {
            alert(`Debes ingresar la fecha de vencimiento de ${tipoDocumento}`);
            return;
        }
        
        // Confirmar el pago
        if (!confirm(`¬øRegistrar pago de ${tipoDocumento} por $${valor.toLocaleString('es-CO')}?`)) {
            return;
        }
        
        // Obtener fecha actual
        const today = new Date().toISOString().split('T')[0];
        
        // Crear el gasto adicional
        const nuevoGasto = {
            fecha: today,
            tipo: tipoDocumento,
            descripcion: descripcion,
            valor: valor,
            placa: currentPlacaVehicle
        };
        
        // Agregar a la lista de gastos adicionales
        gastosAdicionalesList.push(nuevoGasto);
        
        // Actualizar placas de gastos
        await renderizarPlacasGastos();
        
        // Actualizar resumen financiero
        await actualizarResumenFinanciero();
        
        alert(`‚úì Pago de ${tipoDocumento} registrado correctamente como gasto adicional`);
        console.log('Gasto registrado:', nuevoGasto);
    }
    
    // Guardar todos los veh√≠culos al servidor
    async function guardarVehiculos() {
        try {
            if (Object.keys(vehiculosList).length === 0) {
                alert('No hay veh√≠culos para guardar');
                return;
            }
            
            const response = await fetch('/api/vehiculos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ vehiculos: vehiculosList })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`‚úì Se guardaron ${Object.keys(vehiculosList).length} veh√≠culo(s) correctamente`);
            } else {
                alert('Error al guardar veh√≠culos: ' + data.error);
            }
        } catch (error) {
            console.error('Error al guardar veh√≠culos:', error);
            alert('Error al guardar veh√≠culos');
        }
    }
    
    // ==================== FIN FUNCIONES DE GESTI√ìN DE VEH√çCULOS ====================
    
    // Renderizar placas con sus gastos
    async function renderizarPlacasGastos() {
        const container = document.getElementById('platesExpensesContainer');
        if (!container) return;
        
        // Obtener placas del mes actual
        if (monthsList.length === 0) {
            container.innerHTML = '<div class="loading-plates">No hay datos disponibles</div>';
            return;
        }
        
        const currentMonth = monthsList[currentMonthIndex];
        const platesInMonth = monthsData[currentMonth] || [];
        
        if (platesInMonth.length === 0) {
            container.innerHTML = '<div class="loading-plates">No hay placas para este mes</div>';
            return;
        }
        
        let html = '';
        platesInMonth.forEach(plate => {
            const placa = plate.placa;
            // Obtener gastos de esta placa
            const gastosPlaca = gastosAdicionalesList.filter(g => g.placa === placa);
            const totalGastos = gastosPlaca.reduce((sum, g) => sum + (g.valor || 0), 0);
            const cantidadGastos = gastosPlaca.length;
            
            html += `
                <div class="plate-expense-card" onclick="openExpensesModal('${placa}')">
                    <div class="plate-expense-header">
                        <div class="plate-expense-icon">üöõ</div>
                        <div class="plate-expense-name">${placa}</div>
                    </div>
                    <div class="plate-expense-stats">
                        <div class="plate-expense-stat">
                            <div class="stat-label">Gastos</div>
                            <div class="stat-value">${cantidadGastos}</div>
                        </div>
                        <div class="plate-expense-stat">
                            <div class="stat-label">Total</div>
                            <div class="stat-value amount">$${totalGastos.toLocaleString('es-CO')}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Actualizar resumen financiero
        await actualizarResumenFinanciero();
    }
    
    // Funci√≥n para actualizar campos seg√∫n la categor√≠a seleccionada
    function actualizarCamposPorCategoria() {
        const categoria = document.getElementById('newExpenseTypeModal').value;
        const descripcionField = document.getElementById('descripcionField');
        const galonesField = document.getElementById('galonesField');
        const fechaFinalField = document.getElementById('fechaFinalField');
        const diasParqueoHint = document.getElementById('diasParqueoHint');
        
        // Limpiar campos adicionales
        document.getElementById('newExpenseDescriptionModal').value = '';
        document.getElementById('newExpenseGalonesModal').value = '';
        document.getElementById('newExpenseFechaFinalModal').value = '';
        if (diasParqueoHint) diasParqueoHint.style.display = 'none';
        
        // Mostrar/ocultar campos seg√∫n la categor√≠a
        switch(categoria) {
            case 'Combustible':
                // Para Combustible: mostrar galones, ocultar descripci√≥n y fecha final
                descripcionField.style.display = 'none';
                galonesField.style.display = 'block';
                fechaFinalField.style.display = 'none';
                break;
            case 'Parqueaderos':
                // Para Parqueaderos: mostrar fecha final, ocultar descripci√≥n y galones
                descripcionField.style.display = 'none';
                galonesField.style.display = 'none';
                fechaFinalField.style.display = 'block';
                // Agregar listener para calcular d√≠as cuando cambie la fecha final
                const fechaInicio = document.getElementById('newExpenseDateModal');
                const fechaFinal = document.getElementById('newExpenseFechaFinalModal');
                if (fechaInicio && fechaFinal) {
                    fechaFinal.onchange = calcularDiasParqueo;
                    fechaInicio.onchange = calcularDiasParqueo;
                }
                break;
            case 'Peajes':
                // Para Peajes: ocultar descripci√≥n, galones y fecha final
                descripcionField.style.display = 'none';
                galonesField.style.display = 'none';
                fechaFinalField.style.display = 'none';
                break;
            default:
                // Para otras categor√≠as: mostrar descripci√≥n, ocultar galones y fecha final
                descripcionField.style.display = 'block';
                galonesField.style.display = 'none';
                fechaFinalField.style.display = 'none';
                break;
        }
    }
    
    // Funci√≥n para calcular d√≠as de parqueo
    function calcularDiasParqueo() {
        const fechaInicio = document.getElementById('newExpenseDateModal').value;
        const fechaFinal = document.getElementById('newExpenseFechaFinalModal').value;
        const diasParqueoHint = document.getElementById('diasParqueoHint');
        
        if (fechaInicio && fechaFinal && diasParqueoHint) {
            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFinal);
            
            if (fin < inicio) {
                diasParqueoHint.textContent = '‚ö†Ô∏è La fecha final debe ser posterior a la fecha inicial';
                diasParqueoHint.style.color = '#dc3545';
                diasParqueoHint.style.display = 'block';
                return;
            }
            
            // Calcular diferencia en d√≠as (incluyendo el d√≠a inicial)
            const diffTime = Math.abs(fin - inicio);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 para incluir ambos d√≠as
            
            diasParqueoHint.textContent = `üìä Per√≠odo: ${diffDays} d√≠a(s) de parqueo`;
            diasParqueoHint.style.color = '#28a745';
            diasParqueoHint.style.display = 'block';
        } else if (diasParqueoHint) {
            diasParqueoHint.style.display = 'none';
        }
    }
    
    // Abrir modal de gastos para una placa
    function openExpensesModal(placa) {
        currentPlacaExpenses = placa;
        const modal = document.getElementById('expensesModal');
        const modalPlaca = document.getElementById('expensesModalPlaca');
        
        if (!modal || !modalPlaca) {
            console.error('Modal de gastos no encontrado');
            return;
        }
        
        modalPlaca.textContent = placa;
        
        // Obtener gastos de esta placa
        const gastosPlaca = gastosAdicionalesList.filter(g => g.placa === placa);
        const totalGastos = gastosPlaca.reduce((sum, g) => sum + (g.valor || 0), 0);
        const ultimaFecha = gastosPlaca.length > 0 
            ? gastosPlaca.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0].fecha 
            : '-';
        
        // Actualizar resumen
        document.getElementById('expenseModalTotal').textContent = `$${totalGastos.toLocaleString('es-CO')}`;
        document.getElementById('expenseModalCount').textContent = gastosPlaca.length;
        document.getElementById('expenseModalLastDate').textContent = ultimaFecha;
        
        // Renderizar lista de gastos
        renderizarGastosModal(gastosPlaca);
        
        // Establecer fecha actual por defecto
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('newExpenseDateModal').value = today;
        // Establecer fecha final por defecto igual a la inicial para Parqueaderos
        document.getElementById('newExpenseFechaFinalModal').value = today;
        
        // Inicializar campos seg√∫n categor√≠a por defecto
        actualizarCamposPorCategoria();
        
        // Mostrar modal
        modal.style.display = 'block';
    }
    
    // Cerrar modal de gastos
    function closeExpensesModal() {
        const modal = document.getElementById('expensesModal');
        if (modal) {
            modal.style.display = 'none';
        }
        currentPlacaExpenses = null;
    }
    
    // Renderizar gastos en el modal
    function renderizarGastosModal(gastosPlaca) {
        const container = document.getElementById('expensesListModal');
        if (!container) return;
        
        if (!gastosPlaca || gastosPlaca.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">No hay gastos registrados para esta placa</div>';
            return;
        }
        
        let html = '';
        gastosPlaca.forEach((gasto, index) => {
            // Encontrar el √≠ndice real en la lista completa
            const realIndex = gastosAdicionalesList.findIndex(g => 
                g.placa === gasto.placa && 
                g.fecha === gasto.fecha && 
                g.tipo === gasto.tipo && 
                g.valor === gasto.valor
            );
            
            const tipo = gasto.tipo || '';
            const descripcion = gasto.descripcion || '';
            const galones = gasto.galones || null;
            const fechaFinal = gasto.fecha_final || null;
            const dias = gasto.dias || null;
            
            // Construir texto de descripci√≥n seg√∫n la categor√≠a
            let descripcionTexto = '';
            if (tipo === 'Combustible' && galones) {
                descripcionTexto = `${galones} galones`;
            } else if (tipo === 'Parqueaderos' && fechaFinal) {
                if (dias) {
                    descripcionTexto = `${dias} d√≠a(s) - Hasta ${fechaFinal}`;
                } else {
                    descripcionTexto = `Hasta ${fechaFinal}`;
                }
            } else if (descripcion) {
                descripcionTexto = descripcion;
            }
            
            html += `
                <div class="expense-item-card">
                    <div class="expense-item-info">
                        <div class="expense-item-header">
                            <div class="expense-item-icon">üí∞</div>
                            <div class="expense-item-main-info">
                                <div class="expense-item-description">${tipo}${descripcionTexto ? ': ' + descripcionTexto : ''}</div>
                                <div class="expense-item-date">üìÖ ${gasto.fecha}</div>
                            </div>
                        </div>
                    </div>
                    <div class="expense-item-actions">
                        <span class="expense-item-amount">$${Number(gasto.valor).toLocaleString('es-CO')}</span>
                        <button class="btn-delete-expense" onclick="eliminarGastoAdicionalModal(${realIndex})">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Agregar gasto desde el modal
    async function agregarGastoAdicionalModal() {
        if (!currentPlacaExpenses) {
            alert('Error: No hay placa seleccionada');
            return;
        }
        
        const fecha = document.getElementById('newExpenseDateModal').value;
        const tipo = document.getElementById('newExpenseTypeModal').value;
        const descripcion = document.getElementById('newExpenseDescriptionModal').value;
        const galones = parseFloat(document.getElementById('newExpenseGalonesModal').value) || null;
        const fechaFinal = document.getElementById('newExpenseFechaFinalModal').value;
        const valor = parseFloat(document.getElementById('newExpenseValueModal').value) || 0;
        
        if (!fecha) {
            alert('Debes seleccionar una fecha');
            return;
        }
        
        if (!tipo) {
            alert('Debes seleccionar un tipo');
            return;
        }
        
        // Validaciones espec√≠ficas por categor√≠a
        if (tipo === 'Combustible') {
            if (!galones || galones <= 0) {
                alert('Debes ingresar la cantidad de galones');
                return;
            }
        } else if (tipo === 'Parqueaderos') {
            if (!fechaFinal) {
                alert('Debes seleccionar la fecha final del per√≠odo de parqueo');
                return;
            }
            // Validar que la fecha final sea posterior a la fecha inicial
            const inicio = new Date(fecha);
            const fin = new Date(fechaFinal);
            if (fin < inicio) {
                alert('La fecha final debe ser posterior o igual a la fecha inicial');
                return;
            }
        } else if (tipo !== 'Peajes') {
            // Para categor√≠as que requieren descripci√≥n (excepto Peajes)
            if (!descripcion || descripcion.trim() === '') {
                alert('Debes ingresar una descripci√≥n');
                return;
            }
        }
        
        if (valor <= 0) {
            alert('Debes ingresar un valor mayor a 0');
            return;
        }
        
        // Crear objeto de gasto con campos adicionales seg√∫n categor√≠a
        const nuevoGasto = {
            fecha: fecha,
            tipo: tipo,
            valor: valor,
            placa: currentPlacaExpenses
        };
        
        // Agregar campos adicionales seg√∫n la categor√≠a
        if (tipo === 'Combustible' && galones) {
            nuevoGasto.galones = galones;
        } else if (tipo === 'Parqueaderos' && fechaFinal) {
            nuevoGasto.fecha_final = fechaFinal;
            // Calcular d√≠as de parqueo
            const inicio = new Date(fecha);
            const fin = new Date(fechaFinal);
            const diffTime = Math.abs(fin - inicio);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            nuevoGasto.dias = diffDays;
        } else if (descripcion && descripcion.trim() !== '') {
            nuevoGasto.descripcion = descripcion.trim();
        }
        
        gastosAdicionalesList.push(nuevoGasto);
        
        // Actualizar el modal
        const gastosPlaca = gastosAdicionalesList.filter(g => g.placa === currentPlacaExpenses);
        const totalGastos = gastosPlaca.reduce((sum, g) => sum + (g.valor || 0), 0);
        const ultimaFecha = gastosPlaca.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0].fecha;
        
        document.getElementById('expenseModalTotal').textContent = `$${totalGastos.toLocaleString('es-CO')}`;
        document.getElementById('expenseModalCount').textContent = gastosPlaca.length;
        document.getElementById('expenseModalLastDate').textContent = ultimaFecha;
        
        renderizarGastosModal(gastosPlaca);
        
        // Limpiar formulario
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('newExpenseDateModal').value = today;
        document.getElementById('newExpenseTypeModal').value = 'Parqueaderos';
        document.getElementById('newExpenseDescriptionModal').value = '';
        document.getElementById('newExpenseGalonesModal').value = '';
        document.getElementById('newExpenseFechaFinalModal').value = '';
        document.getElementById('newExpenseValueModal').value = '';
        
        // Actualizar campos seg√∫n categor√≠a por defecto
        actualizarCamposPorCategoria();
        
        // Actualizar placas
        await renderizarPlacasGastos();
        
        console.log('Gasto agregado para placa:', currentPlacaExpenses);
    }
    
    // Eliminar gasto desde el modal
    async function eliminarGastoAdicionalModal(index) {
        if (confirm('¬øEst√°s seguro de eliminar este gasto?')) {
            gastosAdicionalesList.splice(index, 1);
            
            // Actualizar el modal si est√° abierto
            if (currentPlacaExpenses) {
                const gastosPlaca = gastosAdicionalesList.filter(g => g.placa === currentPlacaExpenses);
                const totalGastos = gastosPlaca.reduce((sum, g) => sum + (g.valor || 0), 0);
                const ultimaFecha = gastosPlaca.length > 0 
                    ? gastosPlaca.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0].fecha 
                    : '-';
                
                document.getElementById('expenseModalTotal').textContent = `$${totalGastos.toLocaleString('es-CO')}`;
                document.getElementById('expenseModalCount').textContent = gastosPlaca.length;
                document.getElementById('expenseModalLastDate').textContent = ultimaFecha;
                
                renderizarGastosModal(gastosPlaca);
            }
            
            // Actualizar placas
            await renderizarPlacasGastos();
            
            console.log('Gasto eliminado');
        }
    }

    async function cargarTarifasDestino() {
        try {
            const response = await fetch('/api/destinos-tarifas');
            const data = await response.json();
            
            if (data.success && data.destinos) {
                renderizarTarifasDestino(data.destinos);
                console.log('Tarifas por destino cargadas:', data.destinos);
            } else {
                console.error('Error al cargar tarifas:', data.error);
                document.getElementById('tarifasGrid').innerHTML = '<div class="loading-tarifas">Error al cargar destinos</div>';
            }
        } catch (error) {
            console.error('Error al cargar tarifas por destino:', error);
            document.getElementById('tarifasGrid').innerHTML = '<div class="loading-tarifas">Error al cargar destinos</div>';
        }
    }

    function renderizarTarifasDestino(destinos) {
        const container = document.getElementById('tarifasGrid');
        
        if (!destinos || destinos.length === 0) {
            container.innerHTML = '<div class="loading-tarifas">No se encontraron destinos</div>';
            return;
        }
        
        let html = '';
        destinos.forEach(destino => {
            html += `
                <div class="tarifa-item">
                    <div class="tarifa-destino">
                        <span class="destino-name">${destino.destino}</span>
                    </div>
                    <div class="tarifa-input-container">
                        <span class="currency-symbol">$</span>
                        <input type="number" 
                               class="tarifa-input" 
                               data-destino="${destino.destino}"
                               value="${destino.tarifa || 0}" 
                               min="0" 
                               step="1000"
                               placeholder="0">
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Agregar listeners para actualizar gastos en tiempo real
        const tarifaInputs = container.querySelectorAll('.tarifa-input');
        tarifaInputs.forEach(input => {
            input.addEventListener('input', async () => {
                // Actualizar gastos despu√©s de un peque√±o delay para evitar llamadas excesivas
                clearTimeout(input.updateTimeout);
                input.updateTimeout = setTimeout(async () => {
                    await actualizarGastosTotales();
                }, 500); // 500ms de delay
            });
        });
    }

    async function guardarTarifasDestino() {
        try {
            const tarifasInputs = document.querySelectorAll('.tarifa-input');
            const tarifasData = [];
            
            tarifasInputs.forEach(input => {
                const destino = input.getAttribute('data-destino');
                const tarifa = parseFloat(input.value) || 0;
                
                tarifasData.push({
                    destino: destino,
                    tarifa: tarifa
                });
            });
            
            const response = await fetch('/api/destinos-tarifas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tarifas: tarifasData })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Tarifas por destino guardadas correctamente');
                // Recargar datos para actualizar el resumen financiero
                await loadInitial();
                // Recalcular gastos con las nuevas tarifas
                await actualizarGastosTotales();
            } else {
                alert('Error al guardar tarifas: ' + data.error);
            }
        } catch (error) {
            console.error('Error al guardar tarifas por destino:', error);
            alert('Error al guardar tarifas por destino');
        }
    }

    async function guardarGastosAdicionales() {
        try {
            // Validar que haya gastos para guardar
            if (gastosAdicionalesList.length === 0) {
                alert('No hay gastos para guardar');
                return;
            }
            
            const response = await fetch('/api/gastos-adicionales', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ gastos: gastosAdicionalesList })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`‚úì Se guardaron ${gastosAdicionalesList.length} gasto(s) adicionales correctamente`);
                // Recargar datos para actualizar el resumen financiero
                await loadInitial();
            } else {
                alert('Error al guardar gastos: ' + data.error);
            }
        } catch (error) {
            console.error('Error al guardar gastos adicionales:', error);
            alert('Error al guardar gastos adicionales');
        }
    }

    function renderMatches(rows) {
        const container = document.getElementById('matchesTable');
        console.log('Renderizando coincidencias:', rows);
        console.log('Contenedor encontrado:', !!container);
        
        if (!container) {
            console.error('Contenedor matchesTable no encontrado');
            return;
        }
        
        if (!rows || rows.length === 0) {
            container.innerHTML = '<div class="table-empty">Sin coincidencias encontradas</div>';
            return;
        }
        
        let html = '<table class="dynamic-table"><thead><tr>' +
            '<th style="width: 120px;">Load ID</th><th style="width: 100px;">Placa</th><th style="width: 100px;">Mes</th><th style="width: 120px;">Valor</th><th style="width: 150px;">Conductor</th><th style="width: 120px;">Destino</th><th style="width: 120px;">Fecha Inicio</th>' +
            '</tr></thead><tbody>';
        
        for (const r of rows) {
            // Manejar diferentes nombres de campos
            const loadId = r.load_id || r.ID || '';
            const fechaInicio = r.fecha_inicio || r['fecha inicio'] || r['FECHA VIAJE'] || '';
            const valor = r.valormanifiesto || r['VALOR FLETE'] || 0;
            
            html += `<tr>
                <td>${loadId}</td>
                <td>${r.placa ?? ''}</td>
                <td>${r.mes ?? ''}</td>
                <td style="text-align: right; font-weight: 600; color: #28a745;">$${Number(valor || 0).toLocaleString('es-CO')}</td>
                <td title="${r.conductor || ''}">${r.conductor ?? ''}</td>
                <td title="${r.destino || ''}">${r.destino ?? ''}</td>
                <td>${fechaInicio}</td>
            </tr>`;
        }
        html += '</tbody></table>';
        
        container.innerHTML = html;
        console.log('Tabla de coincidencias renderizada con', rows.length, 'filas');
    }

    function renderAllData(rows) {
        const container = document.getElementById('allDataTable');
        console.log('Renderizando todos los datos:', rows);
        console.log('Contenedor encontrado:', !!container);
        
        if (!container) {
            console.error('Contenedor allDataTable no encontrado');
            return;
        }
        
        if (!rows || rows.length === 0) {
            container.innerHTML = '<div class="table-empty">No hay datos disponibles</div>';
            return;
        }
        
        // Obtener las columnas del primer registro
        const firstRow = rows[0];
        const columns = Object.keys(firstRow);
        
        let html = '<table class="dynamic-table"><thead><tr>';
        
        // Crear encabezados din√°micamente
        columns.forEach(col => {
            const width = col === 'valormanifiesto' ? '120px' : 
                         col === 'conductor' || col === 'empresa' || col === 'destino' ? '150px' :
                         col === 'fecha Generacion' || col === 'fecha Vencimiento' || col === 'fecha pago' ? '120px' :
                         col === 'load_id' || col === 'kof' || col === 'remesa' ? '100px' :
                         col === 'placa' || col === 'mes' ? '80px' : '100px';
            html += `<th style="width: ${width};">${col.toUpperCase()}</th>`;
        });
        
        html += '</tr></thead><tbody>';
        
        // Crear filas de datos
        rows.forEach((row, index) => {
            html += '<tr>';
            columns.forEach(col => {
                let value = row[col] || '';
                let cellStyle = '';
                
                if (col === 'valormanifiesto') {
                    value = value ? `$${Number(value).toLocaleString('es-CO')}` : '';
                    cellStyle = 'text-align: right; font-weight: 600; color: #28a745;';
                } else if (col === 'conductor' || col === 'empresa' || col === 'destino') {
                    cellStyle = `title="${value}"`;
                }
                
                html += `<td ${cellStyle}>${value}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        
        container.innerHTML = html;
        console.log('Tabla completa renderizada con', rows.length, 'filas y', columns.length, 'columnas');
    }

    async function loadInitial() {
        console.log('Iniciando carga de datos...');
        try {
            const data = await fetchData();
            console.log('Datos recibidos:', data);
            console.log('Tipo de data:', typeof data);
            console.log('Keys en data:', Object.keys(data));
            console.log('Agregados:', data.aggregates?.length || 0);
            console.log('Tipo de aggregates:', typeof data.aggregates);
            console.log('Coincidencias:', data.matches?.length || 0);
            console.log('All data:', data.all_data?.length || 0);
            
            // Verificar que tenemos datos agregados
            if (!data.aggregates) {
                throw new Error('No se encontraron datos agregados en la respuesta');
            }
            
            // Si aggregates es string, intentar convertirlo a array
            if (typeof data.aggregates === 'string') {
                console.log('Convirtiendo aggregates de string a array...');
                data.aggregates = convertPythonStringToArray(data.aggregates);
                if (!data.aggregates) {
                    throw new Error('No se pudo convertir aggregates de string a array');
                }
            }
            
            if (!Array.isArray(data.aggregates)) {
                console.error('aggregates no es un array despu√©s de la conversi√≥n:', typeof data.aggregates, data.aggregates);
                throw new Error('Los datos agregados no tienen el formato esperado');
            }
            
            if (data.aggregates.length === 0) {
                throw new Error('No se encontraron datos agregados');
            }
            
            // Organizar datos por mes
            organizeDataByMonth(data.aggregates);
            
            // Guardar todos los datos para los detalles
            allData = data.all_data || [];
            
            // Si allData es string, intentar convertirlo a array
            if (typeof allData === 'string') {
                allData = convertPythonStringToArray(allData);
                if (!allData) {
                    console.error('No se pudo convertir allData de string en loadInitial');
                    allData = [];
                } else {
                    console.log('All data convertido de string a array en loadInitial:', allData.length, 'elementos');
                }
            }
            
            // Guardar gastos totales
            gastosTotales = data.gastos_totales || null;
            console.log('Gastos totales:', gastosTotales);
            
            console.log('All data guardado:', allData.length, 'registros');
            
            // Inicializar navegaci√≥n
            currentMonthIndex = 0;
            await updateMonthNavigation();
            
            // Renderizar coincidencias
            renderMatches(data.matches);
            
            console.log('Datos cargados exitosamente');
        } catch (e) {
            console.error('Error al cargar datos:', e);
            const platesContainer = document.getElementById('platesContainer');
            const matchesContainer = document.getElementById('matchesTable');
            
            if (platesContainer) {
                platesContainer.innerHTML = `<div class="loading-plates">Error al cargar datos: ${e.message}</div>`;
            }
            if (matchesContainer) {
                matchesContainer.innerHTML = `<div class="table-empty">Error al cargar datos: ${e.message}</div>`;
            }
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', async () => {
        // Agregar estilos financieros
        addFinancialStyles();
        addPDFButtonStyles();
        
        // Cargar datos iniciales
        await loadInitial();
        
        // Cargar veh√≠culos guardados
        await cargarVehiculos();
        
        // Cargar gastos adicionales guardados
        await cargarGastosAdicionales();
        
        // Cargar tarifas por destino
        await cargarTarifasDestino();
        
        // Actualizar resumen financiero despu√©s de cargar todo
        await actualizarResumenFinanciero();
        
        // Configurar event listeners con validaciones
        const prevBtn = document.getElementById('prevMonthBtn');
        const nextBtn = document.getElementById('nextMonthBtn');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        
        if (prevBtn) {
            prevBtn.addEventListener('click', async () => {
                if (currentMonthIndex > 0) {
                    currentMonthIndex--;
                    await updateMonthNavigation();
                }
            });
        } else {
            console.error('Bot√≥n prevMonthBtn no encontrado');
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', async () => {
                if (currentMonthIndex < monthsList.length - 1) {
                    currentMonthIndex++;
                    await updateMonthNavigation();
                }
            });
        } else {
            console.error('Bot√≥n nextMonthBtn no encontrado');
        }
        
        if (searchBtn) {
            searchBtn.addEventListener('click', async () => {
                const q = document.getElementById('searchInput').value.trim();
                try {
                    const data = await fetchData(q);
                    renderMatches(data.matches);
                } catch (error) {
                    console.error('Error en b√∫squeda:', error);
                }
            });
        } else {
            console.error('Bot√≥n searchBtn no encontrado');
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', async () => {
                document.getElementById('searchInput').value = '';
                try {
                    const data = await fetchData('');
                    renderMatches(data.matches);
                } catch (error) {
                    console.error('Error al limpiar:', error);
                }
            });
        } else {
            console.error('Bot√≥n clearBtn no encontrado');
        }
        
        // Cerrar modal al hacer click fuera de √©l
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('tripsModal');
            if (event.target === modal) {
                closeTripsModal();
            }
        });
        
        // Event listeners para veh√≠culos
        const saveVehiclesBtn = document.getElementById('saveVehiclesBtn');
        const loadVehiclesBtn = document.getElementById('loadVehiclesBtn');
        const saveVehicleBtnModal = document.getElementById('saveVehicleBtnModal');
        
        if (saveVehiclesBtn) {
            saveVehiclesBtn.addEventListener('click', guardarVehiculos);
        }
        
        if (loadVehiclesBtn) {
            loadVehiclesBtn.addEventListener('click', cargarVehiculos);
        }
        
        if (saveVehicleBtnModal) {
            saveVehicleBtnModal.addEventListener('click', guardarVehiculo);
        }
        
        // Cerrar modal de veh√≠culo al hacer click fuera
        window.addEventListener('click', (event) => {
            const vehicleModal = document.getElementById('vehicleModal');
            if (event.target === vehicleModal) {
                closeVehicleModal();
            }
        });
        
        // Event listeners para gastos adicionales
        const saveExpensesBtn = document.getElementById('saveExpensesBtn');
        const loadExpensesBtn = document.getElementById('loadExpensesBtn');
        const addExpenseBtnModal = document.getElementById('addExpenseBtnModal');
        
        if (saveExpensesBtn) {
            saveExpensesBtn.addEventListener('click', guardarGastosAdicionales);
        }
        
        if (loadExpensesBtn) {
            loadExpensesBtn.addEventListener('click', cargarGastosAdicionales);
        }
        
        if (addExpenseBtnModal) {
            addExpenseBtnModal.addEventListener('click', agregarGastoAdicionalModal);
        }
        
        // Cerrar modal de gastos al hacer click fuera
        window.addEventListener('click', (event) => {
            const expensesModal = document.getElementById('expensesModal');
            if (event.target === expensesModal) {
                closeExpensesModal();
            }
        });
        
        // Event listeners para tarifas por destino
        const saveTarifasBtn = document.getElementById('saveTarifasBtn');
        const loadTarifasBtn = document.getElementById('loadTarifasBtn');
        
        if (saveTarifasBtn) {
            saveTarifasBtn.addEventListener('click', guardarTarifasDestino);
        }
        
        if (loadTarifasBtn) {
            loadTarifasBtn.addEventListener('click', cargarTarifasDestino);
        }

        // Gestionar pagos desde desglose: bot√≥n y selector
        async function populateConductorSelect() {
            const conductorSelectForPayments = document.getElementById('conductorSelectForPayments');
            if (!conductorSelectForPayments) {
                console.warn('Selector de conductores no encontrado');
                return;
            }
            
            try {
                let conductores = [];
                // Intentar obtener desde allData primero
                if (allData && Array.isArray(allData) && allData.length > 0) {
                    const setC = new Set();
                    allData.forEach(item => {
                        const c = (item.conductor || '').toString().trim();
                        if (c && c.toLowerCase() !== 'nan' && c.toLowerCase() !== 'none' && c !== '') {
                            setC.add(c);
                        }
                    });
                    conductores = Array.from(setC).sort();
                }
                
                // Si no hay conductores en allData, intentar obtener desde API de resumen de pagos
                if (conductores.length === 0) {
                    try {
                        const response = await fetch('/api/resumen-pagos');
                        const data = await response.json();
                        if (data.success && data.resumen) {
                            conductores = Object.keys(data.resumen).sort();
                        }
                    } catch (e) {
                        console.warn('No se pudo obtener conductores desde API:', e);
                    }
                }
                
                conductorSelectForPayments.innerHTML = '<option value="">Selecciona un conductor</option>' +
                    conductores.map(c => `<option value="${c.replace(/"/g,'&quot;')}">${c}</option>`).join('');
                    
                console.log(`Selector poblado con ${conductores.length} conductores`);
            } catch (e) {
                console.error('Error populando conductores:', e);
            }
        }
        
        // Poblar selector de conductores despu√©s de cargar datos
        await populateConductorSelect();
        
        const openPaymentsFromBreakdownBtn = document.getElementById('openPaymentsFromBreakdownBtn');
        if (openPaymentsFromBreakdownBtn) {
            openPaymentsFromBreakdownBtn.addEventListener('click', () => {
                const sel = document.getElementById('conductorSelectForPayments');
                const conductor = sel && sel.value ? sel.value : '';
                if (!conductor) {
                    alert('Selecciona un conductor');
                    return;
                }
                openPaymentsModal(conductor);
            });
        }

        // Bot√≥n para imprimir carta de deuda del conductor
        const printDebtLetterBtn = document.getElementById('printDebtLetterBtn');
        if (printDebtLetterBtn) {
            printDebtLetterBtn.addEventListener('click', printConductorDebtLetter);
        }
    });

    // Variables para el modal de pagos
    let currentPagosConductor = null;
    let selectedPagosIds = [];

    // Funci√≥n para abrir el modal de pagos
    async function openPaymentsModal(conductor) {
        console.log('=== INICIANDO openPaymentsModal ===');
        console.log('Conductor:', conductor);
        
        const modal = document.getElementById('paymentsModal');
        console.log('Modal encontrado:', !!modal);
        
        if (!modal) {
            console.error('Error: Modal no encontrado en el DOM');
            alert('Error: No se encontr√≥ el modal de pagos');
            return;
        }
        
        try {
            console.log('Haciendo fetch a:', `/api/pagos-conductor/${encodeURIComponent(conductor)}`);
            
            // Obtener datos de pagos del conductor
            const response = await fetch(`/api/pagos-conductor/${encodeURIComponent(conductor)}`);
            console.log('Response status:', response.status);
            
            const data = await response.json();
            console.log('Datos recibidos:', data);
            
            if (!data.success) {
                const errorMsg = data.error || 'Error desconocido';
                console.error('Error al cargar pagos:', errorMsg);
                alert('Error al cargar pagos: ' + errorMsg + '\n\nNota: El archivo de pagos se crear√° autom√°ticamente la primera vez.');
                return;
            }
            
            console.log('‚úì Datos cargados exitosamente');
            
            currentPagosConductor = data;
            
            // Llenar informaci√≥n del conductor
            document.getElementById('paymentConductorName').textContent = data.conductor;
            document.getElementById('paymentTotalPaid').textContent = `$${data.total_pagado.toLocaleString('es-CO')}`;
            document.getElementById('paymentTotalPending').textContent = `$${data.total_pendiente.toLocaleString('es-CO')}`;
            
            // Llenar la fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDateInput').value = today;
            
            // Combinar viajes pendientes y pagados para mostrar todos
            const todosLosViajes = [...(data.viajes_pendientes || []), ...(data.viajes_pagados || [])];
            console.log('Total viajes a mostrar:', todosLosViajes.length);
            console.log('Viajes pendientes:', data.viajes_pendientes?.length || 0);
            console.log('Viajes pagados:', data.viajes_pagados?.length || 0);
            renderPagosPendientes(todosLosViajes);
            
            // Mostrar modal
            console.log('Mostrando modal...');
            modal.style.display = 'block';
            console.log('Modal mostrado, display:', modal.style.display);
            console.log('=== FIN openPaymentsModal ===');
            
        } catch (error) {
            console.error('Error al cargar pagos del conductor:', error);
            console.error('Stack trace:', error.stack);
            alert('Error al cargar pagos del conductor: ' + error.message);
        }
    }

    // Funci√≥n para cerrar el modal de pagos
    function closePaymentsModal() {
        const modal = document.getElementById('paymentsModal');
        modal.style.display = 'none';
        selectedPagosIds = [];
        currentPagosConductor = null;
    }

    // Funci√≥n para renderizar las tarjetas de viajes pendientes
    function renderPagosPendientes(viajes) {
        const container = document.getElementById('pendientesTableContainer');
        
        if (!viajes || viajes.length === 0) {
            container.innerHTML = '<div class="table-empty" style="padding: 40px; text-align: center; color: #6c757d;">No hay viajes disponibles para este conductor</div>';
            return;
        }
        
        let html = `
            <div class="payment-select-all" style="margin-bottom: 16px;">
                <label for="selectAllCheckbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 14px 16px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6; transition: all 0.2s ease; min-height: 48px;">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)" style="width: 28px; height: 28px; min-width: 28px; min-height: 28px; cursor: pointer; flex-shrink: 0;">
                    <span style="font-weight: 600; color: #495057; user-select: none; font-size: 1em;">Seleccionar todos los viajes</span>
                </label>
            </div>
            <div class="payment-trips-grid">
        `;
        
        viajes.forEach((viaje, index) => {
            console.log(`Viaje ${index}:`, viaje);
            // Verificar estado de m√∫ltiples formas posibles
            const estado = (viaje.estado || viaje.estado_pago || 'PENDIENTE').toString().toUpperCase().trim();
            const fechaPago = viaje.fecha_pago || '';
            const isPaid = estado === 'PAGADO' || estado === 'PAGO' || (fechaPago && fechaPago.trim() !== '');
            
            console.log(`Viaje ${viaje.load_id}: estado="${estado}", fechaPago="${fechaPago}", isPaid=${isPaid}`);
            
            html += `
                <div class="trip-payment-card ${isPaid ? 'trip-paid' : 'trip-pending'}" data-load-id="${viaje.load_id}">
                    <div class="trip-card-header">
                        <div class="trip-load-id">
                            <span class="load-id-label">Load ID</span>
                            <span class="load-id-value">${viaje.load_id}</span>
                        </div>
                        <div class="trip-status-badge ${isPaid ? 'status-paid' : 'status-pending'}">
                            ${isPaid ? '‚úì PAGADO' : '‚è≥ PENDIENTE'}
                        </div>
                    </div>
                    
                    <div class="trip-card-body">
                        <div class="trip-info-item">
                            <span class="trip-label">üìÖ Fecha Viaje:</span>
                            <span class="trip-value">${viaje.fecha_viaje || 'N/A'}</span>
                        </div>
                        ${fechaPago ? `
                        <div class="trip-info-item">
                            <span class="trip-label">üí∞ Fecha Pago:</span>
                            <span class="trip-value" style="color: #28a745; font-weight: 600;">${fechaPago}</span>
                        </div>
                        ` : ''}
                        <div class="trip-info-item">
                            <span class="trip-label">üìç Destino:</span>
                            <span class="trip-value">${viaje.destino || 'N/A'}</span>
                        </div>
                        <div class="trip-info-item highlight">
                            <span class="trip-label">üíµ Tarifa:</span>
                            <span class="trip-value amount-highlight" style="color: ${isPaid ? '#28a745' : '#28a745'};">$${Number(viaje.tarifa || 0).toLocaleString('es-CO')}</span>
                        </div>
                    </div>
                    
                    <div class="trip-card-footer">
                        ${isPaid ? `
                        <div class="trip-checkbox-wrapper" style="cursor: not-allowed; opacity: 0.7; pointer-events: none;">
                            <input type="checkbox" class="trip-checkbox" id="checkbox-${viaje.load_id}" data-load-id="${viaje.load_id}" data-tarifa="${viaje.tarifa}" disabled checked>
                            <span class="checkbox-custom" style="background: #28a745; border-color: #28a745;"></span>
                            <span class="checkbox-label" style="color: #28a745; font-weight: 700;">‚úì Ya Pagado</span>
                        </div>
                        ` : `
                        <label class="trip-checkbox-wrapper" for="checkbox-${viaje.load_id}">
                            <input type="checkbox" class="trip-checkbox" id="checkbox-${viaje.load_id}" data-load-id="${viaje.load_id}" data-tarifa="${viaje.tarifa}">
                            <span class="checkbox-custom"></span>
                            <span class="checkbox-label">‚úì Seleccionar para pagar</span>
                        </label>
                        `}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';  // Cerrar payment-trips-grid
        container.innerHTML = html;
        
        // Agregar event listeners a los checkboxes despu√©s de renderizar
        const checkboxes = container.querySelectorAll('.trip-checkbox:not([disabled])');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updatePaymentSummary);
        });
    }

    // Funci√≥n para actualizar el resumen de selecci√≥n
    function updatePaymentSummary() {
        // Solo obtener checkboxes marcados que NO est√©n deshabilitados
        const checkboxes = document.querySelectorAll('.trip-checkbox:checked:not([disabled])');
        selectedPagosIds = [];
        let totalSelected = 0;
        
        checkboxes.forEach(checkbox => {
            if (!checkbox.disabled) {
                const loadId = checkbox.getAttribute('data-load-id');
                const tarifa = parseFloat(checkbox.getAttribute('data-tarifa'));
                selectedPagosIds.push(loadId);
                totalSelected += tarifa;
            }
        });
        
        // Actualizar resumen
        document.getElementById('selectedCount').textContent = selectedPagosIds.length;
        document.getElementById('selectedTotal').textContent = `$${totalSelected.toLocaleString('es-CO')}`;
        
        // Mostrar/ocultar secci√≥n de resumen y bot√≥n de confirmar
        const summarySection = document.getElementById('paymentSummarySection');
        const confirmBtn = document.getElementById('confirmPaymentBtn');
        
        if (selectedPagosIds.length > 0) {
            summarySection.style.display = 'block';
            confirmBtn.style.display = 'block';
        } else {
            summarySection.style.display = 'none';
            confirmBtn.style.display = 'none';
        }
    }

    // Funci√≥n para seleccionar/deseleccionar todos
    function toggleSelectAll(checked) {
        const checkboxes = document.querySelectorAll('.trip-checkbox:not([disabled])');
        console.log(`Seleccionando/deseleccionando ${checkboxes.length} checkboxes, checked=${checked}`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
            // Disparar evento change manualmente para actualizar el resumen
            const event = new Event('change', { bubbles: true });
            checkbox.dispatchEvent(event);
        });
        updatePaymentSummary();
    }

    // Funci√≥n para confirmar pagos
    async function confirmPayments() {
        console.log('confirmPayments() clicado');
        console.log('Viajes seleccionados:', selectedPagosIds);
        if (selectedPagosIds.length === 0) {
            console.warn('No hay viajes seleccionados para pagar');
            alert('Debes seleccionar al menos un viaje para pagar');
            return;
        }
        const fechaPago = document.getElementById('paymentDateInput').value;
        console.log('Fecha de pago:', fechaPago);
        if (!fechaPago) {
            alert('Debes seleccionar una fecha de pago');
            return;
        }
        const totalTexto = document.getElementById('selectedTotal').textContent;
        console.log('Total seleccionado (texto):', totalTexto);
        if (!confirm(`¬øConfirmar pago de ${selectedPagosIds.length} viaje(s)?\nTotal: ${totalTexto}`)) {
            console.log('Confirmaci√≥n de pago cancelada por el usuario');
            return;
        }

        const confirmBtn = document.getElementById('confirmPaymentBtn');
        if (confirmBtn) confirmBtn.disabled = true;

        const payload = {
            load_ids: selectedPagosIds,
            estado_pago: 'PAGADO',
            fecha_pago: fechaPago,
            tipo_pago: 'conductor'  // Pago al conductor (no al manifiesto)
        };
        console.log('Payload a enviar /api/pagos-actualizar:', payload);

        try {
            const response = await fetch('/api/pagos-actualizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            console.log('Respuesta /api/pagos-actualizar status:', response.status);
            const data = await response.json();
            console.log('Respuesta /api/pagos-actualizar body:', data);

            if (data.success) {
                console.log('Pagos actualizados correctamente en backend');
                alert('‚úì Pagos actualizados correctamente');

                if (currentPagosConductor) {
                    const conductor = currentPagosConductor.conductor;
                    console.log('Refrescando datos de conductor:', conductor);
                    const response2 = await fetch(`/api/pagos-conductor/${encodeURIComponent(conductor)}`);
                    console.log('Respuesta /api/pagos-conductor status:', response2.status);
                    const dataRefresh = await response2.json();
                    console.log('Respuesta /api/pagos-conductor body:', dataRefresh);

                    if (dataRefresh.success) {
                        document.getElementById('paymentTotalPaid').textContent = `$${dataRefresh.total_pagado.toLocaleString('es-CO')}`;
                        document.getElementById('paymentTotalPending').textContent = `$${dataRefresh.total_pendiente.toLocaleString('es-CO')}`;
                        const todosLosViajes = [...(dataRefresh.viajes_pendientes || []), ...(dataRefresh.viajes_pagados || [])];
                        renderPagosPendientes(todosLosViajes);
                        selectedPagosIds = [];
                        document.getElementById('paymentSummarySection').style.display = 'none';
                        document.getElementById('confirmPaymentBtn').style.display = 'none';
                    } else {
                        console.warn('No se pudo refrescar datos del conductor:', dataRefresh.error);
                    }
                }

                try {
                    console.log('Actualizando gastos totales y resumen financiero tras pago...');
                    await actualizarGastosTotales();
                    await actualizarResumenFinanciero();
                    console.log('Resumen financiero actualizado');
                } catch (e) {
                    console.error('Error al refrescar resumen tras pago:', e);
                }
            } else {
                console.error('Backend devolvi√≥ error en pagos-actualizar:', data.error);
                alert('Error al actualizar pagos: ' + (data.error || 'Desconocido'));
            }
        } catch (error) {
            console.error('Error al confirmar pagos (fetch):', error);
            alert('Error al confirmar pagos: ' + error.message);
        } finally {
            if (confirmBtn) confirmBtn.disabled = false;
        }
    }

    // Cerrar modal de pagos al hacer click fuera
    window.addEventListener('click', (event) => {
        const paymentsModal = document.getElementById('paymentsModal');
        if (event.target === paymentsModal) {
            closePaymentsModal();
        }
    });

    // Agregar estilos para el bot√≥n PDF
    function addPDFButtonStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .btn-action {
                background: none;
                border: none;
                padding: 8px 12px;
                margin: 0 2px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.2s ease;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 36px;
                height: 36px;
            }
            
            .view-btn {
                background: linear-gradient(45deg, #17a2b8, #138496);
                color: white;
                box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
            }
            
            .view-btn:hover {
                background: linear-gradient(45deg, #138496, #0f6674);
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(23, 162, 184, 0.4);
            }
            
            .view-btn:active {
                transform: translateY(0);
            }
            
            .pay-btn {
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
                font-size: 0.9em;
                padding: 8px 14px;
                white-space: nowrap;
                min-width: 140px;
            }
            
            .pay-btn:hover {
                background: linear-gradient(45deg, #20c997, #1e7e34);
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
            }
            
            .pay-btn:active {
                transform: translateY(0);
            }
            
            /* Estilos espec√≠ficos para el modal de detalles de viajes */
            #tripsModal .modal-content {
                max-width: 1400px;
                width: 95%;
            }
            
            #tripsModal .modal-body {
                padding: 25px;
            }
            
            #tripsModal .table-container {
                max-height: 60vh;
                overflow-y: auto;
                overflow-x: auto;
            }
            
            #tripsModal .dynamic-table {
                min-width: 1000px;
            }
            
            /* Responsive para modal de detalles */
            @media (max-width: 1400px) {
                #tripsModal .modal-content {
                    width: 98%;
                    max-width: 98%;
                }
            }
            
            @media (max-width: 768px) {
                #tripsModal .modal-content {
                    width: 100%;
                    max-width: 100%;
                    margin: 0;
                    border-radius: 0;
                    max-height: 100vh;
                }
                
                #tripsModal .modal-body {
                    padding: 15px;
                }
                
                #tripsModal .summary-stats {
                    grid-template-columns: repeat(2, 1fr) !important;
                    gap: 10px !important;
                    padding: 15px !important;
                }
                
                #tripsModal .table-container {
                    max-height: 50vh;
                }
                
                #tripsModal .dynamic-table {
                    font-size: 0.85em;
                }
                
                #tripsModal .pay-btn {
                    font-size: 0.8em;
                    padding: 6px 10px;
                    min-width: 120px;
                }
            }
        `;
        document.head.appendChild(style);
    }

    // Agregar estilos para el resumen financiero
    function addFinancialStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .financial-summary {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 12px;
                padding: 20px;
                margin: 20px 0;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            
            .summary-cards {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 20px;
            }
            
            .summary-card {
                background: white;
                border-radius: 8px;
                padding: 16px;
                display: flex;
                align-items: center;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                transition: transform 0.2s ease;
            }
            
            .summary-card:hover {
                transform: translateY(-2px);
            }
            
            .summary-card.income {
                border-left: 4px solid #28a745;
            }
            
            .summary-card.expenses {
                border-left: 4px solid #dc3545;
            }
            
            .summary-card.profit {
                border-left: 4px solid #007bff;
            }
            
            .card-icon {
                font-size: 2em;
                margin-right: 12px;
            }
            
            .card-content {
                flex: 1;
            }
            
            .card-label {
                font-size: 0.9em;
                color: #666;
                margin-bottom: 4px;
            }
            
            .card-value {
                font-size: 1.4em;
                font-weight: bold;
                color: #333;
            }
            
            .expenses-breakdown {
                background: white;
                border-radius: 8px;
                padding: 16px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .breakdown-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 12px;
                margin-top: 12px;
            }
            
            .breakdown-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 12px;
                background: #f8f9fa;
                border-radius: 6px;
                border-left: 3px solid #6c757d;
            }
            
            .breakdown-item-total {
                grid-column: 1 / -1;
                background: #ffffff;
                border-radius: 12px;
                padding: 20px;
                border: 2px solid #28a745;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
            }
            
            .breakdown-item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 2px solid #e9ecef;
            }
            
            .breakdown-item-details {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .breakdown-detail-row {
                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                padding: 14px 16px;
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: 1px solid #e9ecef;
            }
            
            .breakdown-sub-label {
                font-weight: 600;
                color: #495057;
                font-size: 0.95em;
            }
            
            .breakdown-sub-value {
                font-weight: bold;
                font-size: 1.1em;
            }
            
            .breakdown-sub-value.paid {
                color: #28a745;
            }
            
            .breakdown-sub-value.pending {
                color: #ffc107;
            }
            
            .breakdown-label {
                font-weight: 500;
                color: #495057;
            }
            
            .breakdown-value {
                font-weight: bold;
                color: #dc3545;
                font-size: 1.2em;
            }
            
            @media (max-width: 768px) {
                .breakdown-item-details {
                    grid-template-columns: 1fr;
                }
            }
            
            .expenses-form {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 16px;
                border: 1px solid #dee2e6;
            }
            
            .expenses-form-modern {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border-radius: 16px;
                padding: 24px;
                border: 2px solid #e9ecef;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            
            .expenses-form-header {
                margin-bottom: 24px;
                text-align: center;
            }
            
            .expenses-form-header h4 {
                margin: 0 0 8px 0;
                color: #2c3e50;
                font-size: 1.4em;
            }
            
            .expenses-form-header p {
                margin: 0;
                color: #6c757d;
                font-size: 0.95em;
            }
            
            .expenses-cards-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
                margin-bottom: 20px;
            }
            
            .expense-card {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border: 2px solid #e9ecef;
                border-radius: 12px;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 16px;
                transition: all 0.3s ease;
                cursor: pointer;
            }
            
            .expense-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            }
            
            .expense-parking {
                border-color: #17a2b8;
            }
            
            .expense-parking:hover {
                border-color: #138496;
            }
            
            .expense-parts {
                border-color: #ffc107;
            }
            
            .expense-parts:hover {
                border-color: #e0a800;
            }
            
            .expense-labor {
                border-color: #6f42c1;
            }
            
            .expense-labor:hover {
                border-color: #5a32a3;
            }
            
            .expense-card-icon {
                font-size: 2.5em;
                width: 70px;
                height: 70px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            
            .expense-parking .expense-card-icon {
                background: linear-gradient(135deg, #17a2b8, #138496);
                box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
            }
            
            .expense-parts .expense-card-icon {
                background: linear-gradient(135deg, #ffc107, #e0a800);
                box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
            }
            
            .expense-labor .expense-card-icon {
                background: linear-gradient(135deg, #6f42c1, #5a32a3);
                box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
            }
            
            .expense-card-content {
                width: 100%;
            }
            
            .expense-card-label {
                display: block;
                font-weight: 700;
                color: #2c3e50;
                margin-bottom: 12px;
                text-align: center;
                font-size: 1.1em;
            }
            
            .expense-input-wrapper {
                display: flex;
                align-items: center;
                gap: 8px;
                background: white;
                border: 2px solid #e9ecef;
                border-radius: 10px;
                padding: 4px 12px;
                transition: all 0.3s ease;
            }
            
            .expense-parking .expense-input-wrapper:focus-within {
                border-color: #17a2b8;
                box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
            }
            
            .expense-parts .expense-input-wrapper:focus-within {
                border-color: #ffc107;
                box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
            }
            
            .expense-labor .expense-input-wrapper:focus-within {
                border-color: #6f42c1;
                box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.1);
            }
            
            .expense-parking .expense-currency {
                color: #17a2b8;
            }
            
            .expense-parts .expense-currency {
                color: #ffc107;
            }
            
            .expense-labor .expense-currency {
                color: #6f42c1;
            }
            
            .expense-currency {
                font-weight: 700;
                font-size: 1.3em;
                flex-shrink: 0;
            }
            
            .expense-input {
                border: none;
                outline: none;
                font-size: 1.2em;
                font-weight: 700;
                color: #2c3e50;
                text-align: right;
                width: 100%;
                padding: 8px 0;
            }
            
            .expense-input::placeholder {
                color: #adb5bd;
            }
            
            .expense-form-actions {
                display: flex;
                gap: 12px;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .btn-save-expense {
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                border: none;
                padding: 12px 32px;
                border-radius: 10px;
                font-weight: 700;
                font-size: 1em;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            }
            
            .btn-save-expense:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            }
            
            .btn-load-expense {
                background: linear-gradient(135deg, #6c757d, #495057);
                color: white;
                border: none;
                padding: 12px 32px;
                border-radius: 10px;
                font-weight: 700;
                font-size: 1em;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            }
            
            .btn-load-expense:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
            }
            
            .form-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 16px;
            }
            
            .form-group {
                display: flex;
                flex-direction: column;
            }
            
            .form-group label {
                font-weight: 500;
                color: #495057;
                margin-bottom: 4px;
            }
            
            .form-input {
                padding: 8px 12px;
                border: 1px solid #ced4da;
                border-radius: 4px;
                font-size: 14px;
                transition: border-color 0.2s ease;
            }
            
            .form-input:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            }
            
            .form-actions {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
            }
            
            /* Estilos para la lista de gastos */
            .expenses-list-container {
                max-height: 400px;
                overflow-y: auto;
                margin-bottom: 20px;
                border: 2px solid #e9ecef;
                border-radius: 12px;
                padding: 16px;
                background: #f8f9fa;
            }
            
            .expense-item-card {
                background: white;
                border: 2px solid #e9ecef;
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: all 0.3s ease;
            }
            
            .expense-item-card:hover {
                transform: translateX(4px);
                border-color: #dc3545;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            
            .expense-item-info {
                flex: 1;
            }
            
            .expense-item-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 8px;
            }
            
            .expense-item-icon {
                font-size: 1.8em;
                width: 45px;
                height: 45px;
                background: linear-gradient(135deg, #dc3545, #c82333);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .expense-item-main-info {
                flex: 1;
            }
            
            .expense-item-description {
                font-weight: 700;
                color: #2c3e50;
                font-size: 1.1em;
                margin-bottom: 4px;
            }
            
            .expense-item-date {
                font-size: 0.85em;
                color: #6c757d;
            }
            
            .expense-item-actions {
                display: flex;
                align-items: center;
                gap: 16px;
            }
            
            .expense-item-amount {
                font-size: 1.3em;
                font-weight: bold;
                color: #dc3545;
                white-space: nowrap;
            }
            
            .btn-delete-expense {
                background: #dc3545;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .btn-delete-expense:hover {
                background: #c82333;
                transform: scale(1.05);
            }
            
            .add-expense-form {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border: 2px dashed #e9ecef;
                border-radius: 12px;
                padding: 24px;
                margin-bottom: 20px;
            }
            
            .add-expense-form h5 {
                margin: 0 0 16px 0;
                color: #2c3e50;
                font-size: 1.1em;
            }
            
            .expense-form-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                align-items: end;
            }
            
            .form-field-full {
                grid-column: span 2;
            }
            
            .form-field {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .form-field label {
                font-weight: 600;
                color: #495057;
                font-size: 0.9em;
            }
            
            .form-field-input {
                padding: 10px 14px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 1em;
                transition: all 0.3s ease;
            }
            
            .form-field-input:focus {
                outline: none;
                border-color: #dc3545;
                box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
            }
            
            .form-field-actions {
                display: flex;
                align-items: end;
            }
            
            .btn-add-expense {
                background: linear-gradient(135deg, #dc3545, #c82333);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-weight: 700;
                font-size: 1em;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
                width: 100%;
            }
            
            .btn-add-expense:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
            }
            
            .expense-input-wrapper-new {
                display: flex;
                align-items: center;
                gap: 8px;
                background: white;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                padding: 4px 14px;
                transition: all 0.3s ease;
            }
            
            .expense-input-wrapper-new:focus-within {
                border-color: #dc3545;
                box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
            }
            
            /* Estilos profesionales para el formulario de gastos */
            .add-expense-form-professional {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border: 1px solid #e0e0e0;
                border-radius: 16px;
                padding: 32px;
                margin-bottom: 24px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                position: relative;
                overflow: hidden;
            }
            
            .add-expense-form-professional::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, #dc3545, #c82333, #dc3545);
                background-size: 200% 100%;
                animation: shimmer 3s infinite;
            }
            
            @keyframes shimmer {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
            
            .expense-form-header-professional {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-bottom: 28px;
                padding-bottom: 20px;
                border-bottom: 2px solid #f0f0f0;
            }
            
            .expense-form-icon-wrapper {
                width: 64px;
                height: 64px;
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                border-radius: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
                flex-shrink: 0;
            }
            
            .expense-form-icon {
                font-size: 32px;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            }
            
            .expense-form-title-section {
                flex: 1;
            }
            
            .expense-form-title {
                margin: 0 0 6px 0;
                color: #1a1a1a;
                font-size: 1.5em;
                font-weight: 700;
                letter-spacing: -0.5px;
            }
            
            .expense-form-subtitle {
                margin: 0;
                color: #6c757d;
                font-size: 0.95em;
                font-weight: 400;
            }
            
            .expense-form-grid-professional {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 24px;
                align-items: start;
            }
            
            .form-field-professional {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .form-field-full-professional {
                grid-column: 1 / -1;
            }
            
            .form-label-professional {
                display: flex;
                align-items: center;
                gap: 8px;
                font-weight: 600;
                color: #2c3e50;
                font-size: 0.9em;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 4px;
            }
            
            .label-icon {
                font-size: 1.1em;
                filter: grayscale(0.2);
            }
            
            .label-text {
                color: #495057;
            }
            
            .form-input-professional {
                padding: 14px 18px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 1em;
                font-weight: 500;
                color: #2c3e50;
                background: #ffffff;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                width: 100%;
                box-sizing: border-box;
            }
            
            .form-input-professional::placeholder {
                color: #adb5bd;
                font-weight: 400;
            }
            
            .form-input-professional:hover {
                border-color: #dc3545;
                box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);
            }
            
            .form-input-professional:focus {
                outline: none;
                border-color: #dc3545;
                box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.15), 0 4px 12px rgba(220, 53, 69, 0.1);
                transform: translateY(-1px);
            }
            
            .form-select-professional {
                cursor: pointer;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 18px center;
                padding-right: 45px;
            }
            
            .expense-input-wrapper-professional {
                display: flex;
                align-items: center;
                gap: 12px;
                background: #ffffff;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                padding: 0 18px;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .expense-input-wrapper-professional:hover {
                border-color: #dc3545;
                box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);
            }
            
            .expense-input-wrapper-professional:focus-within {
                border-color: #dc3545;
                box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.15), 0 4px 12px rgba(220, 53, 69, 0.1);
                transform: translateY(-1px);
            }
            
            .expense-currency-professional {
                font-weight: 700;
                font-size: 1.2em;
                color: #dc3545;
                flex-shrink: 0;
            }
            
            .expense-input-professional {
                border: none;
                outline: none;
                font-size: 1.1em;
                font-weight: 600;
                color: #2c3e50;
                text-align: right;
                width: 100%;
                padding: 14px 0;
                background: transparent;
            }
            
            .expense-input-professional::placeholder {
                color: #adb5bd;
                font-weight: 400;
            }
            
            .expense-unit-professional {
                font-weight: 600;
                font-size: 0.95em;
                color: #6c757d;
                text-transform: lowercase;
                flex-shrink: 0;
                padding-left: 8px;
                border-left: 1px solid #e0e0e0;
            }
            
            /* Ajuste para el input de galones */
            #newExpenseGalonesModal {
                text-align: left;
            }
            
            /* Estilos para el hint de d√≠as de parqueo */
            .field-hint {
                display: block;
                margin-top: 6px;
                padding: 6px 10px;
                background: #f8f9fa;
                border-radius: 6px;
                font-size: 0.85em;
                font-weight: 500;
                transition: all 0.3s ease;
            }
            
            .field-hint[style*="color: #28a745"] {
                background: #d4edda;
                border-left: 3px solid #28a745;
            }
            
            .field-hint[style*="color: #dc3545"] {
                background: #f8d7da;
                border-left: 3px solid #dc3545;
            }
            
            .form-field-actions-professional {
                display: flex;
                align-items: end;
                grid-column: 1 / -1;
            }
            
            .btn-add-expense-professional {
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                color: white;
                border: none;
                padding: 16px 32px;
                border-radius: 12px;
                font-weight: 700;
                font-size: 1.05em;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 6px 20px rgba(220, 53, 69, 0.35);
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                position: relative;
                overflow: hidden;
            }
            
            .btn-add-expense-professional::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                transition: left 0.5s;
            }
            
            .btn-add-expense-professional:hover::before {
                left: 100%;
            }
            
            .btn-add-expense-professional:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 30px rgba(220, 53, 69, 0.45);
            }
            
            .btn-add-expense-professional:active {
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            }
            
            .btn-icon {
                font-size: 1.2em;
                filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
            }
            
            .btn-text {
                letter-spacing: 0.3px;
            }
            
            /* Estilos para bot√≥n de pago de documentos */
            .btn-pay-document {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-weight: 700;
                font-size: 0.95em;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.35);
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                position: relative;
                overflow: hidden;
            }
            
            .btn-pay-document::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                transition: left 0.5s;
            }
            
            .btn-pay-document:hover::before {
                left: 100%;
            }
            
            .btn-pay-document:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(40, 167, 69, 0.45);
            }
            
            .btn-pay-document:active {
                transform: translateY(0);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
            }
            
            @media (max-width: 768px) {
                .expenses-cards-grid {
                    grid-template-columns: 1fr;
                }
                
                .expense-form-grid {
                    grid-template-columns: 1fr;
                }
                
                .expense-form-grid-professional {
                    grid-template-columns: 1fr;
                }
                
                .add-expense-form-professional {
                    padding: 24px;
                }
                
                .expense-form-header-professional {
                    flex-direction: column;
                    text-align: center;
                }
                
                .form-field-actions-professional {
                    grid-column: 1;
                }
            }
            
            @media (max-width: 768px) {
                .summary-cards {
                    grid-template-columns: 1fr;
                }
                
                .breakdown-grid {
                    grid-template-columns: 1fr;
                }
                
                .form-grid {
                    grid-template-columns: 1fr;
                }
                
                .form-actions {
                    justify-content: stretch;
                }
                
                .form-actions button {
                    flex: 1;
                }
            }
            
            .tarifas-section {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 16px;
                padding: 24px;
                margin: 24px 0;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            .tarifas-section h3 {
                color: white;
                margin: 0 0 16px 0;
                font-size: 1.5em;
                font-weight: 700;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }
            
            .tarifas-container {
                background: rgba(255, 255, 255, 0.95);
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
            }
            
            .tarifas-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 24px;
                flex-wrap: wrap;
                gap: 16px;
            }
            
            .tarifas-header p {
                margin: 0;
                color: #6c757d;
                font-style: italic;
                font-size: 0.95em;
                background: linear-gradient(45deg, #667eea, #764ba2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            .tarifas-actions {
                display: flex;
                gap: 12px;
            }
            
            .tarifas-actions button {
                padding: 10px 20px;
                border-radius: 8px;
                font-weight: 600;
                transition: all 0.3s ease;
                border: none;
                cursor: pointer;
                font-size: 14px;
            }
            
            .tarifas-actions .process-btn {
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            }
            
            .tarifas-actions .process-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            }
            
            .tarifas-actions .btn-cancel {
                background: linear-gradient(45deg, #6c757d, #495057);
                color: white;
                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            }
            
            .tarifas-actions .btn-cancel:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
            }
            
            .tarifas-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 20px;
            }
            
            .tarifa-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 20px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 12px;
                border-left: 5px solid #667eea;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            
            .tarifa-item::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .tarifa-item:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }
            
            .tarifa-item:hover::before {
                opacity: 1;
            }
            
            .tarifa-destino {
                flex: 1;
                position: relative;
                z-index: 1;
            }
            
            .destino-name {
                font-weight: 700;
                color: #2c3e50;
                font-size: 16px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .tarifa-input-container {
                display: flex;
                align-items: center;
                gap: 8px;
                position: relative;
                z-index: 1;
            }
            
            .currency-symbol {
                font-weight: 700;
                color: #28a745;
                font-size: 18px;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            
            .tarifa-input {
                width: 140px;
                padding: 12px 16px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                text-align: right;
                transition: all 0.3s ease;
                background: white;
                color: #495057;
            }
            
            .tarifa-input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                transform: scale(1.02);
            }
            
            .tarifa-input:hover {
                border-color: #667eea;
            }
            
            .loading-tarifas {
                text-align: center;
                color: #6c757d;
                font-style: italic;
                padding: 40px 20px;
                font-size: 16px;
                background: linear-gradient(45deg, #f8f9fa, #e9ecef);
                border-radius: 12px;
                border: 2px dashed #dee2e6;
            }
            
            @media (max-width: 768px) {
                .tarifas-section {
                    padding: 20px;
                    margin: 20px 0;
                }
                
                .tarifas-header {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 12px;
                }
                
                .tarifas-actions {
                    justify-content: stretch;
                }
                
                .tarifas-actions button {
                    flex: 1;
                    padding: 12px 16px;
                }
                
                .tarifas-grid {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }
                
                .tarifa-item {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 12px;
                    padding: 16px;
                }
                
                .tarifa-input-container {
                    justify-content: center;
                }
                
                .tarifa-input {
                    width: 100%;
                    text-align: center;
                }
            }
            
            @media (max-width: 480px) {
                .tarifas-section h3 {
                    font-size: 1.3em;
                }
                
                .tarifas-container {
                    padding: 16px;
                }
                
                .tarifa-item {
                    padding: 12px;
                }
                
                .destino-name {
                    font-size: 14px;
                }
                
                .tarifa-input {
                    font-size: 14px;
                    padding: 10px 12px;
                }
            }
            
            /* Estilos para el modal de pagos */
            .payment-header-info {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
                margin-bottom: 20px;
            }
            
            .info-card {
                background: white;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            
            .info-label {
                font-size: 0.9em;
                color: #666;
                margin-bottom: 8px;
                font-weight: 500;
            }
            
            .info-value {
                font-size: 1.4em;
                font-weight: bold;
                color: #333;
            }
            
            .info-value.income {
                color: #28a745;
            }
            
            .info-value.expense {
                color: #dc3545;
            }
            
            .payment-date-input {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .payment-date-input label {
                font-weight: 600;
                color: #495057;
            }
            
            .payment-date-input input {
                padding: 10px 16px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 16px;
                transition: all 0.3s ease;
            }
            
            .payment-date-input input:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            }
            
            .summary-info {
                display: flex;
                gap: 24px;
                margin-top: 12px;
            }
            
            .summary-info span {
                font-size: 1.1em;
            }
            
            .summary-info strong {
                font-size: 1.2em;
                color: #007bff;
            }
            
            @media (max-width: 768px) {
                .payment-header-info {
                    grid-template-columns: 1fr;
                }
                
                .summary-info {
                    flex-direction: column;
                    gap: 12px;
                }
            }
            
            /* Estilos para las tarjetas de viajes */
            .payment-trips-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 16px;
                margin-top: 20px;
            }
            
            .trip-payment-card {
                background: white;
                border-radius: 12px;
                padding: 16px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                transition: all 0.3s ease;
                border: 2px solid #e9ecef;
            }
            
            .trip-payment-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            }
            
            .trip-paid {
                border-left: 4px solid #28a745;
                background: linear-gradient(135deg, #f8fff9 0%, #e8f5e9 100%);
                opacity: 0.8;
            }
            
            .trip-paid:hover {
                opacity: 1;
            }
            
            .trip-pending {
                border-left: 4px solid #ffc107;
            }
            
            .trip-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 2px solid #f1f3f5;
            }
            
            .trip-load-id {
                display: flex;
                flex-direction: column;
            }
            
            .load-id-label {
                font-size: 0.75em;
                color: #6c757d;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                font-weight: 600;
            }
            
            .load-id-value {
                font-size: 1.2em;
                font-weight: bold;
                color: #333;
                margin-top: 4px;
            }
            
            .trip-status-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.85em;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .status-paid {
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
            }
            
            .status-pending {
                background: linear-gradient(135deg, #ffc107, #ff9800);
                color: white;
                box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
            }
            
            .trip-card-body {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 12px;
            }
            
            .trip-info-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #f1f3f5;
            }
            
            .trip-info-item.highlight {
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                padding: 12px;
                border-radius: 8px;
                border-bottom: none;
                margin-top: 4px;
            }
            
            .trip-label {
                font-weight: 600;
                color: #495057;
                font-size: 0.9em;
            }
            
            .trip-value {
                color: #333;
                font-size: 0.95em;
                text-align: right;
            }
            
            .trip-value.amount-highlight {
                font-size: 1.3em;
                font-weight: bold;
                color: #28a745;
            }
            
            .trip-card-footer {
                padding-top: 12px;
                border-top: 2px solid #f1f3f5;
            }
            
            .trip-checkbox-wrapper {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 10px;
                border-radius: 8px;
                transition: background 0.2s ease;
            }
            
            .trip-payment-card.trip-pending .trip-checkbox-wrapper {
                cursor: pointer;
            }
            
            .trip-payment-card.trip-pending .trip-checkbox-wrapper:hover {
                background: #f8f9fa;
            }
            
            .trip-payment-card.trip-paid .trip-checkbox-wrapper {
                cursor: not-allowed;
                opacity: 0.6;
            }
            
            .trip-payment-card.trip-paid .trip-checkbox-wrapper:hover {
                background: transparent;
            }
            
            .trip-checkbox {
                display: none;
            }
            
            .checkbox-custom {
                width: 24px;
                height: 24px;
                border: 3px solid #6c757d;
                border-radius: 6px;
                position: relative;
                transition: all 0.2s ease;
            }
            
            .trip-checkbox:checked + .checkbox-custom {
                background: #28a745;
                border-color: #28a745;
            }
            
            .trip-checkbox:checked + .checkbox-custom::after {
                content: '‚úì';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                font-size: 16px;
                font-weight: bold;
            }
            
            .trip-checkbox:disabled + .checkbox-custom {
                background: #e9ecef;
                border-color: #dee2e6;
                cursor: not-allowed;
            }
            
            .checkbox-label {
                font-size: 0.95em;
                font-weight: 600;
                color: #495057;
                user-select: none;
            }
            
            .trip-checkbox:disabled ~ .checkbox-label {
                color: #28a745;
                font-weight: 700;
            }
            
            .trip-paid .checkbox-label {
                color: #28a745;
            }
            
            @media (max-width: 768px) {
                .payment-trips-grid {
                    grid-template-columns: 1fr;
                }
            }
            
            /* Estilos para la lista de pagos realizados */
            .payments-list-section {
                background: white;
                border-radius: 8px;
                padding: 16px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .payments-list-section h4 {
                margin: 0 0 16px 0;
                color: #495057;
                font-size: 1.2em;
            }
            
            .payments-cards-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 12px;
                max-height: 400px;
                overflow-y: auto;
                padding: 4px;
                scrollbar-width: thin;
                scrollbar-color: #28a745 #f0f0f0;
            }
            
            .payments-cards-grid::-webkit-scrollbar {
                width: 8px;
            }
            
            .payments-cards-grid::-webkit-scrollbar-track {
                background: #f0f0f0;
                border-radius: 4px;
            }
            
            .payments-cards-grid::-webkit-scrollbar-thumb {
                background: #28a745;
                border-radius: 4px;
            }
            
            .payments-cards-grid::-webkit-scrollbar-thumb:hover {
                background: #20c997;
            }
            
            .payment-card {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border: 2px solid #e9ecef;
                border-radius: 10px;
                overflow: hidden;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            }
            
            .payment-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
                border-color: #28a745;
            }
            
            .payment-card-header {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                border-bottom: 2px solid #e9ecef;
            }
            
            .payment-card-icon {
                font-size: 1.8em;
                width: 45px;
                height: 45px;
                background: linear-gradient(135deg, #28a745, #20c997);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                flex-shrink: 0;
            }
            
            .payment-card-info {
                flex: 1;
                min-width: 0;
            }
            
            .payment-card-name {
                font-size: 0.95em;
                font-weight: 700;
                color: #2c3e50;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .payment-card-date {
                font-size: 0.75em;
                color: #6c757d;
                font-weight: 500;
            }
            
            .payment-card-amount {
                font-size: 1.1em;
                font-weight: bold;
                color: #28a745;
                text-align: right;
                white-space: nowrap;
            }
            
            .payment-card-arrow {
                font-size: 1.2em;
                color: #6c757d;
                transition: transform 0.3s ease;
                flex-shrink: 0;
            }
            
            .payment-card-details {
                padding: 12px;
                background: #f8f9fa;
                border-top: 2px solid #e9ecef;
            }
            
            .payment-details-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .payment-detail-item {
                background: white;
                padding: 10px 12px;
                border-radius: 6px;
                border-left: 3px solid #28a745;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            }
            
            .payment-detail-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 6px;
                font-size: 0.85em;
            }
            
            .payment-detail-info:last-child {
                margin-bottom: 0;
            }
            
            .payment-detail-info.highlight {
                background: linear-gradient(135deg, #f0fff4 0%, #e8f5e9 100%);
                padding: 8px;
                border-radius: 5px;
                margin-top: 6px;
            }
            
            .payment-detail-label {
                font-weight: 600;
                color: #6c757d;
                font-size: 0.85em;
            }
            
            .payment-detail-value {
                font-weight: 700;
                color: #333;
                text-align: right;
                font-size: 0.9em;
            }
            
            .payment-detail-info.highlight .payment-detail-value {
                color: #28a745;
                font-size: 1em;
            }
            
            @media (max-width: 768px) {
                .payments-cards-grid {
                    grid-template-columns: 1fr;
                }
            }
            
            /* Estilos para tarjetas de placas de gastos */
            .plates-expenses-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 16px;
                margin-top: 20px;
            }
            
            .plate-expense-card {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border: 2px solid #e9ecef;
                border-radius: 12px;
                padding: 20px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            
            .plate-expense-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
                border-color: #dc3545;
            }
            
            .plate-expense-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 2px solid #e9ecef;
            }
            
            .plate-expense-icon {
                font-size: 2em;
                width: 50px;
                height: 50px;
                background: linear-gradient(135deg, #dc3545, #c82333);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            
            .plate-expense-name {
                font-size: 1.3em;
                font-weight: 700;
                color: #2c3e50;
            }
            
            .plate-expense-stats {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .plate-expense-stat {
                text-align: center;
                padding: 12px;
                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                border-radius: 8px;
                border: 1px solid #e9ecef;
            }
            
            .plate-expense-stat .stat-label {
                font-size: 0.85em;
                color: #6c757d;
                font-weight: 600;
                margin-bottom: 6px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .plate-expense-stat .stat-value {
                font-size: 1.2em;
                font-weight: bold;
                color: #2c3e50;
            }
            
            .plate-expense-stat .stat-value.amount {
                color: #dc3545;
                font-size: 1.3em;
            }
            
            @media (max-width: 768px) {
                .plates-expenses-container {
                    grid-template-columns: 1fr;
                }
            }
            
            /* Estilos para secci√≥n de veh√≠culos */
            .vehicles-section-modern {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border-radius: 16px;
                padding: 24px;
                border: 2px solid #e9ecef;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            
            .vehicles-section-header {
                margin-bottom: 24px;
                text-align: center;
            }
            
            .vehicles-section-header h4 {
                margin: 0 0 8px 0;
                color: #2c3e50;
                font-size: 1.4em;
            }
            
            .vehicles-section-header p {
                margin: 0;
                color: #6c757d;
                font-size: 0.95em;
            }
            
            .vehicles-form-actions {
                display: flex;
                gap: 12px;
                justify-content: center;
                flex-wrap: wrap;
                margin-top: 20px;
            }
            
            .plates-vehicles-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 16px;
                margin-top: 20px;
            }
            
            .plate-vehicle-card {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border: 2px solid #e9ecef;
                border-radius: 12px;
                padding: 20px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                position: relative;
            }
            
            .plate-vehicle-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
                border-color: #007bff;
            }
            
            .plate-vehicle-card.has-data {
                border-color: #28a745;
                background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
            }
            
            .plate-vehicle-card.has-data:hover {
                border-color: #20c997;
            }
            
            .plate-vehicle-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 2px solid #e9ecef;
                position: relative;
            }
            
            .plate-vehicle-icon {
                font-size: 2em;
                width: 50px;
                height: 50px;
                background: linear-gradient(135deg, #007bff, #0056b3);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            
            .plate-vehicle-name {
                font-size: 1.3em;
                font-weight: 700;
                color: #2c3e50;
                flex: 1;
            }
            
            .plate-vehicle-badge {
                position: absolute;
                top: -8px;
                right: -8px;
                width: 28px;
                height: 28px;
                background: linear-gradient(135deg, #28a745, #20c997);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 0.9em;
                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
            }
            
            .plate-vehicle-info {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .vehicle-info-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 14px;
                background: #f8f9fa;
                border-radius: 8px;
                font-size: 0.9em;
                margin-bottom: 8px;
                border-left: 4px solid #e9ecef;
                transition: all 0.3s ease;
            }
            
            .vehicle-info-item:hover {
                transform: translateX(2px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .info-left {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .info-icon {
                font-size: 1.1em;
            }
            
            .vehicle-info-item .info-label {
                color: #6c757d;
                font-weight: 600;
            }
            
            .vehicle-info-item .info-value {
                color: #2c3e50;
                font-weight: 600;
                text-align: right;
                font-size: 0.95em;
            }
            
            /* Estados de vencimiento */
            .vehicle-info-item.status-ok {
                background: linear-gradient(135deg, #d4edda, #c3e6cb);
                border-left-color: #28a745;
            }
            
            .vehicle-info-item.status-ok .info-value {
                color: #155724;
            }
            
            .vehicle-info-item.status-close {
                background: linear-gradient(135deg, #fff3cd, #ffeaa7);
                border-left-color: #ffc107;
            }
            
            .vehicle-info-item.status-close .info-value {
                color: #856404;
            }
            
            .vehicle-info-item.status-warning {
                background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
                border-left-color: #ff9800;
            }
            
            .vehicle-info-item.status-warning .info-value {
                color: #e65100;
                font-weight: 700;
            }
            
            .vehicle-info-item.status-today {
                background: linear-gradient(135deg, #f8d7da, #f5c6cb);
                border-left-color: #dc3545;
            }
            
            .vehicle-info-item.status-today .info-value {
                color: #721c24;
                font-weight: 700;
            }
            
            .vehicle-info-item.status-expired {
                background: linear-gradient(135deg, #f8d7da, #f1aeb5);
                border-left-color: #dc3545;
                animation: pulse-warning 2s infinite;
            }
            
            .vehicle-info-item.status-expired .info-value {
                color: #721c24;
                font-weight: 700;
            }
            
            @keyframes pulse-warning {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.8; }
            }
            
            .vehicle-info-item.status-unknown {
                background: #f8f9fa;
                border-left-color: #6c757d;
            }
            
            .vehicle-info-item.status-unknown .info-value {
                color: #6c757d;
            }
            
            .vehicle-info-empty {
                text-align: center;
                padding: 20px;
                color: #adb5bd;
                font-style: italic;
                font-size: 0.9em;
            }
            
            /* Estilos para formulario de veh√≠culo */
            .vehicle-form-professional {
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border: 1px solid #e0e0e0;
                border-radius: 16px;
                padding: 32px;
                margin-bottom: 24px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                position: relative;
                overflow: hidden;
            }
            
            .vehicle-form-professional::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, #007bff, #0056b3, #007bff);
                background-size: 200% 100%;
                animation: shimmer 3s infinite;
            }
            
            .vehicle-form-header-professional {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-bottom: 28px;
                padding-bottom: 20px;
                border-bottom: 2px solid #f0f0f0;
            }
            
            .vehicle-form-icon-wrapper {
                width: 64px;
                height: 64px;
                background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                border-radius: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
                flex-shrink: 0;
            }
            
            .vehicle-form-icon {
                font-size: 32px;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            }
            
            .vehicle-form-title-section {
                flex: 1;
            }
            
            .vehicle-form-title {
                margin: 0 0 6px 0;
                color: #1a1a1a;
                font-size: 1.5em;
                font-weight: 700;
                letter-spacing: -0.5px;
            }
            
            .vehicle-form-subtitle {
                margin: 0;
                color: #6c757d;
                font-size: 0.95em;
                font-weight: 400;
            }
            
            .vehicle-form-grid-professional {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 24px;
                align-items: start;
            }
            
            @media (max-width: 768px) {
                .plates-vehicles-container {
                    grid-template-columns: 1fr;
                }
                
                .vehicle-form-grid-professional {
                    grid-template-columns: 1fr;
                }
            }
        `;
        document.head.appendChild(style);
    }

    // Estilos cargados desde static/css/operaciones.css

    // =====================
    //  Cartas de Deuda
    // =====================
    function formatCurrencyCOP(value) {
        return Number(value || 0).toLocaleString('es-CO');
    }

    function getSpanishDateLong() {
        const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
        const d = new Date();
        return `${String(d.getDate()).padStart(2,'0')} de ${meses[d.getMonth()]} de ${d.getFullYear()}`;
    }

    function getGeneratedAtString() {
        const d = new Date();
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} a las ${hh}:${mm}`;
    }

    function buildConductorRows(detalles) {
        if (!Array.isArray(detalles)) return '';
        return detalles.map(v => {
            const isPaid = (v.estado || '').toUpperCase() === 'PAGADO';
            const estadoClass = isPaid ? 'estado-pagado' : 'estado-pendiente';
            const estadoText = isPaid ? '‚úÖ PAGADO' : '‚è≥ PENDIENTE';
            const fechaPago = v.fecha_pago || 'No pagado';
            return `
                <tr>
                    <td>${v.load_id || ''}</td>
                    <td>${v.fecha_viaje || ''}</td>
                    <td>${v.destino || ''}</td>
                    <td>$${formatCurrencyCOP(v.tarifa || v.monto || 0)}</td>
                    <td class="${estadoClass}">${estadoText}</td>
                    <td>${fechaPago}</td>
                </tr>
            `;
        }).join('');
    }

    function renderTemplate(templateId, placeholders) {
        const tpl = document.getElementById(templateId);
        if (!tpl) {
            alert('Template no encontrado: ' + templateId);
            return null;
        }
        let html = tpl.innerHTML;
        Object.entries(placeholders).forEach(([k, v]) => {
            const re = new RegExp(`\\{\\{${k}\\}\\}`, 'g');
            html = html.replace(re, String(v));
        });
        return html;
    }

    function openHtmlInNewTab(html) {
        const w = window.open('', '_blank');
        if (!w) {
            alert('Bloqueador de ventanas emergentes activo. Permite pop-ups para continuar.');
            return;
        }
        w.document.open('text/html');
        w.document.write(html);
        w.document.close();
        try { w.focus(); } catch (_) {}
    }

    function printConductorDebtLetter() {
        if (!currentPagosConductor) {
            alert('Primero abre el modal de pagos de un conductor.');
            return;
        }

        const conductor = currentPagosConductor.conductor || 'Sin Conductor';
        const pagados = Array.isArray(currentPagosConductor.viajes_pagados) ? currentPagosConductor.viajes_pagados : [];
        const pendientes = Array.isArray(currentPagosConductor.viajes_pendientes) ? currentPagosConductor.viajes_pendientes : [];
        const todos = [...pendientes, ...pagados];

        // Normalizar campos para template
        const detalles = todos.map(v => ({
            load_id: v.load_id,
            fecha_viaje: v.fecha_viaje,
            destino: v.destino,
            tarifa: v.tarifa,
            estado: v.estado || (pagados.includes(v) ? 'PAGADO' : 'PENDIENTE'),
            fecha_pago: v.fecha_pago || ''
        }));

        const placeholders = {
            CONDUCTOR: conductor,
            FECHA_CARTA: getSpanishDateLong(),
            TOTAL_VIAJES: String(detalles.length),
            VIAJES_PAGADOS: String(pagados.length),
            VIAJES_PENDIENTES: String(pendientes.length),
            TOTAL_PAGADO: formatCurrencyCOP(currentPagosConductor.total_pagado || 0),
            TOTAL_PENDIENTE: formatCurrencyCOP(currentPagosConductor.total_pendiente || 0),
            FILAS_VIAJES: buildConductorRows(detalles),
            FECHA_GENERADO: getGeneratedAtString()
        };

        const html = renderTemplate('carta-deuda-conductor-template', placeholders);
        if (html) openHtmlInNewTab(html);
    }
    </script>
    
    <!-- Templates HTML movidos desde Python para separaci√≥n de responsabilidades -->
    <template id="carta-deuda-conductor-template">
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Carta de Deuda - {{CONDUCTOR}}</title>
            <!-- Estilos de carta provienen de static/css/operaciones.css -->
        </head>
        <body>
            <div class="carta-container">
                <div class="header">
                    <h1>üìã CARTA DE DEUDA</h1>
                    <p>Control de Pagos a Conductores</p>
                    <p>{{FECHA_CARTA}}</p>
                </div>
                <div class="contenido">
                    <div class="saludo">
                        <strong>Estimado/a {{CONDUCTOR}},</strong>
                    </div>
                    <p>Por medio de la presente, le informamos el estado actual de sus pagos correspondientes a los viajes realizados:</p>
                    <div class="resumen-deuda">
                        <h3>üìä Resumen de Deuda</h3>
                        <p><strong>Total de viajes realizados:</strong> {{TOTAL_VIAJES}}</p>
                        <p><strong>Viajes pagados:</strong> {{VIAJES_PAGADOS}}</p>
                        <p><strong>Viajes pendientes de pago:</strong> {{VIAJES_PENDIENTES}}</p>
                        <p><strong>Total pagado:</strong> ${{TOTAL_PAGADO}}</p>
                        <div class="deuda-total">üí∞ DEUDA TOTAL: ${{TOTAL_PENDIENTE}}</div>
                    </div>
                    <h3>üìã Detalle de Viajes</h3>
                    <table class="tabla-viajes">
                        <thead>
                            <tr>
                                <th>Load ID</th>
                                <th>Fecha Viaje</th>
                                <th>Destino</th>
                                <th>Tarifa</th>
                                <th>Estado</th>
                                <th>Fecha Pago</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{FILAS_VIAJES}}
                        </tbody>
                    </table>
                    <p><strong>Nota:</strong> Esta carta refleja el estado de pagos al {{FECHA_CARTA}}. Los pagos se realizan seg√∫n el cronograma establecido y las tarifas acordadas por destino.</p>
                    <p>Si tiene alguna consulta sobre estos montos, no dude en contactarnos.</p>
                    <div class="firma">
                        <p>Atentamente,</p>
                        <div class="firma-line"></div>
                        <p><strong>Gerencia de Operaciones</strong></p>
                    </div>
                </div>
                <div class="footer">
                    <p>üìÖ Generado autom√°ticamente el {{FECHA_GENERADO}}</p>
                </div>
            </div>
        </body>
        </html>
    </template>

    <template id="carta-general-deudas-template">
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Carta General de Deudas - {{FECHA_CARTA}}</title>
            <!-- Estilos de carta provienen de static/css/operaciones.css -->
        </head>
        <body>
            <div class="carta-container">
                <div class="header">
                    <h1>üìã CARTA GENERAL DE DEUDAS</h1>
                    <p>Control de Pagos a Conductores</p>
                    <p>{{FECHA_CARTA}}</p>
                </div>
                <div class="resumen-general">
                    <h3>üìä Resumen General</h3>
                    <p><strong>Total de conductores:</strong> {{TOTAL_CONDUCTORES}}</p>
                    <p><strong>Total de viajes pagados:</strong> {{TOTAL_VIAJES_PAGADOS}}</p>
                    <p><strong>Total de viajes pendientes:</strong> {{TOTAL_VIAJES_PENDIENTES}}</p>
                    <p><strong>Total pagado a conductores:</strong> ${{TOTAL_GENERAL_PAGADO}}</p>
                    <div class="deuda-total-general">üí∞ DEUDA TOTAL GENERAL: ${{TOTAL_GENERAL_PENDIENTE}}</div>
                </div>
                <h3>üë• Deuda por Conductor</h3>
                <table class="tabla-conductores">
                    <thead>
                        <tr>
                            <th>Conductor</th>
                            <th>Viajes Totales</th>
                            <th>Viajes Pagados</th>
                            <th>Viajes Pendientes</th>
                            <th>Total Pagado</th>
                            <th>Deuda Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{FILAS_CONDUCTORES}}
                    </tbody>
                </table>
                <p><strong>Nota:</strong> Esta carta refleja el estado de pagos al {{FECHA_CARTA}}. Los montos pendientes representan la deuda total con cada conductor.</p>
                <div class="footer">
                    <p>üìÖ Generado autom√°ticamente el {{FECHA_GENERADO}}</p>
                </div>
            </div>
        </body>
        </html>
    </template>
</body>
</html>



